<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë™ûÊñáÈóñÈóúË∂£(‰∏≠Áè≠)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 20px;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #F8F9FA 0%, #E8F4F8 50%, #F0F8F0 100%);
            min-height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure body takes full viewport height */
        }

        .game-container {
            max-width: 1200px;
            width: 95%; /* Make container slightly responsive */
            margin: 20px auto; /* Add some vertical margin too */
            background: #FEFEFE;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 2px solid #E8F4F8;
            position: relative; /* For positioning the fullscreen button */
        }

        .fullscreen-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            width: 50px;
            height: 50px;
            background-color: #fff;
            border: 2px solid #D6E7F0;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out;
            z-index: 1001;
        }

        .fullscreen-btn:hover {
            transform: scale(1.1);
            border-color: #9BC5D9;
        }

        .fullscreen-btn svg {
            width: 24px;
            height: 24px;
            stroke: #6B9BD1;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .game-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .game-title {
            font-size: 2.8rem;
            color: #6B9BD1;
            margin: 0 0 20px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
            font-weight: 600;
        }

        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
        }

        .progress-dot {
            width: 50px;
            height: 50px;
            transition: all 0.4s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
        }

        .progress-dot::before {
            content: 'üí°';
            filter: grayscale(100%) brightness(0.7);
            transition: all 0.4s ease;
        }

        .progress-dot.completed::before {
            content: 'üí°';
            filter: none;
            animation: lightGlow 0.6s ease;
        }

        .question-counter {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .game-area {
            display: flex;
            gap: 50px;
            align-items: flex-start;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 1000px;
            margin: 0 auto;
        }

        .word-section {
            flex: 0 0 350px;
            text-align: center;
        }

        .word-card {
            width: 350px;
            height: 500px;
            border: 5px solid #B8D4E3;
            border-radius: 25px;
            background: #FEFEFE;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
        }

        .word-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-color: #9BC5D9;
        }

        .word-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 15px;
        }

        .options-section {
            flex: 0 0 480px;
            display: flex;
            justify-content: center;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            width: 100%;
        }

        .option-card {
            width: 220px;
            height: 280px;
            border: 2px solid #D6E7F0;
            border-radius: 20px;
            background: #FEFEFE;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 12px rgba(0,0,0,0.06);
        }

        .option-card:hover {
            border-color: #9BC5D9;
            transform: translateY(-2px);
            box-shadow: 0 5px 18px rgba(0,0,0,0.08);
            background: #F8FCFF;
        }

        .option-card.correct {
            border: 6px solid #7FB069;
            background: #F0F8ED;
            animation: correctPulse 0.6s ease;
            box-shadow: 0 6px 20px rgba(127, 176, 105, 0.2);
            transform: scale(1.02);
        }

        .option-card.wrong {
            border-color: #B0B0B0;
            background: #F8F8F8;
            animation: wrongShake 0.6s ease;
            opacity: 0.5;
            filter: grayscale(40%);
            position: relative;
        }

        .option-card.wrong::after {
            content: '‚úó';
            position: absolute;
            top: 10px;
            right: 10px;
            color: #FF4444;
            font-size: 30px;
            font-weight: bold;
            background: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .option-card.selected-wrong {
            border-color: #B0B0B0;
            background: #F8F8F8;
            animation: wrongShake 0.6s ease;
            opacity: 0.5;
            filter: grayscale(40%);
            position: relative;
        }

        .option-card.selected-wrong::after {
            content: '‚úó';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FF4444;
            font-size: 80px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .option-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 10px;
        }

        .next-button {
            display: none;
            margin: 20px auto 0 auto;
            padding: 18px 45px;
            font-size: 1.4rem;
            background: linear-gradient(45deg, #8BB8D8, #6B9BD1);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(107, 155, 209, 0.2);
            font-weight: 500;
        }

        .next-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 155, 209, 0.3);
            background: linear-gradient(45deg, #7AABCD, #5A8BC4);
        }

        .completion-screen {
            display: none;
            text-align: center;
            padding: 60px;
            background: #F8FCFF;
            border-radius: 25px;
            margin: 20px 0;
        }

        .completion-title {
            font-size: 3.2rem;
            color: #7FB069;
            margin-bottom: 25px;
            animation: bounce 1.5s infinite;
            font-weight: 600;
        }

        .score-display {
            font-size: 2.2rem;
            color: #5A7A8A;
            margin-bottom: 35px;
            font-weight: 500;
        }

        .restart-button {
            padding: 18px 45px;
            font-size: 1.4rem;
            background: linear-gradient(45deg, #8BB8D8, #6B9BD1);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(107, 155, 209, 0.2);
        }

        .restart-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 155, 209, 0.3);
            background: linear-gradient(45deg, #7AABCD, #5A8BC4);
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }

        @keyframes lightGlow {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFD700;
            animation: confetti-fall 3s linear forwards;
        }

        .confetti-piece:nth-child(odd) {
            background: #FF6B6B;
            border-radius: 50%;
        }

        .confetti-piece:nth-child(3n) {
            background: #4ECDC4;
            transform: rotate(45deg);
        }

        .confetti-piece:nth-child(4n) {
            background: #45B7D1;
        }

        .confetti-piece:nth-child(5n) {
            background: #96CEB4;
            border-radius: 50%;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .seat-selection-screen {
            display: block;
            text-align: center;
            padding: 40px;
            background: #F8FCFF;
            border-radius: 25px;
            margin: 20px 0;
        }

        .seat-selection-title {
            font-size: 2.5rem;
            color: #6B9BD1;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .seat-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 0 auto 30px auto;
        }

        .seat-button {
            width: 80px;
            height: 80px;
            border: 3px solid #D6E7F0;
            border-radius: 15px;
            background: #FEFEFE;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: #6B9BD1;
            box-shadow: 0 3px 12px rgba(0,0,0,0.06);
        }

        .seat-button:hover {
            border-color: #9BC5D9;
            transform: translateY(-2px);
            box-shadow: 0 5px 18px rgba(0,0,0,0.08);
            background: #F8FCFF;
        }

        .seat-button.completed {
            background: #E8F5E8;
            border-color: #7FB069;
            color: #5A8A4A;
            cursor: not-allowed;
        }

        .seat-button.completed::after {
            content: ' ‚úì';
            color: #7FB069;
        }

        .teacher-controls {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #E8F4F8;
            text-align: center; /* Center buttons within this div */
        }

        .teacher-button {
            padding: 15px 35px;
            font-size: 1.2rem;
            background: linear-gradient(45deg, #8BB8D8, #6B9BD1);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(107, 155, 209, 0.2);
            margin: 5px 10px; /* Add vertical margin for wrapping */
        }

        .teacher-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 155, 209, 0.3);
            background: linear-gradient(45deg, #7AABCD, #5A8BC4);
        }

        /* --- Analysis Report Styles --- */
        .analysis-screen {
            display: none;
            text-align: center;
            padding: 40px;
            background: #F0F4F8; /* Light background for the whole screen */
            border-radius: 25px;
            margin: 20px 0;
        }

        .analysis-title {
            font-size: 2.5rem;
            color: #6B9BD1;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .analysis-content-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px; /* Space between cards */
            text-align: left;
            max-width: 900px;
            margin: 20px auto;
        }

        .analysis-card {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            border: 1px solid #E0E8EF;
        }

        .analysis-card h3 {
            color: #6B9BD1;
            font-size: 1.4rem; /* Slightly larger title */
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #E8F4F8;
            padding-bottom: 8px;
            display: flex;
            align-items: center; /* Align icon and text */
        }
        .analysis-card h3 svg { /* Style for potential icons in h3 */
            margin-right: 8px;
        }

        .analysis-card p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 10px;
            color: #555;
        }
        .analysis-card p strong {
             color: #444;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            justify-content: space-around; /* Distribute space */
            flex-wrap: wrap; /* Allow wrapping on small screens */
            margin-top: 15px;
        }

        .stat-card {
            background: #F8FCFF;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #E0E8EF;
            text-align: center;
            flex: 1; /* Make cards share space */
            min-width: 180px; /* Minimum width before wrapping */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stat-card-title {
            font-size: 1rem;
            color: #6B9BD1;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-card-value {
            font-size: 1.8rem;
            color: #333;
            font-weight: 600;
        }

        .error-words-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Responsive grid */
            gap: 10px;
            margin-top: 15px;
        }

        .error-word-item {
            background: #FFF8E1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #FFECB3;
            text-align: center;
            font-size: 1rem;
            color: #8D6E63;
            font-weight: 500;
        }

        .suggestion-list {
            list-style: none; /* Remove default bullets */
            padding-left: 0;
            margin-top: 15px;
        }

        .suggestion-list li {
            font-size: 1.1rem;
            line-height: 1.7;
            color: #555;
            padding-left: 25px; /* Space for custom bullet */
            position: relative;
            margin-bottom: 10px;
        }

        .suggestion-list li::before {
            content: 'üí°'; /* Custom bullet */
            position: absolute;
            left: 0;
            top: 1px;
            color: #FFB74D;
        }

        /* --- End Analysis Report Styles --- */


        .report-header { /* For the temporary header during export */
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #E8F4F8;
        }
        .report-header h2 {
            margin: 0;
            color: #6B9BD1;
        }
        .report-header p {
            margin: 5px 0 0;
            font-size: 1.1rem;
            color: #555;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
        .loader {
          border: 8px solid #f3f3f3;
          border-radius: 50%;
          border-top: 8px solid #6B9BD1;
          width: 60px;
          height: 60px;
          animation: spin 2s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            /* Ensure it appears even if other elements have high z-index */
            visibility: hidden; /* Hidden by default */
            opacity: 0; /* Hidden by default */
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .modal-overlay.visible {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }

        .modal-content {
            background: white;
            padding: 30px 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            transform: scale(0.9); /* Start slightly smaller */
             opacity: 0; /* Start invisible */
             transition: transform 0.3s ease, opacity 0.3s ease;
        }
         .modal-overlay.visible .modal-content {
             transform: scale(1); /* Scale to normal size */
             opacity: 1; /* Fade in */
         }


        .modal-content h2 {
            color: #6B9BD1;
            margin-top: 0;
        }
        .modal-content input {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 2px solid #D6E7F0;
            font-size: 1rem;
        }
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .modal-buttons .teacher-button.cancel {
            background: linear-gradient(45deg, #aaa, #888);
        }
        .modal-buttons .teacher-button.cancel:hover {
            background: linear-gradient(45deg, #999, #777);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* Reduce padding on small screens */
                 align-items: flex-start; /* Align container to top on mobile */
            }
            .game-container {
                padding: 20px;
                width: 100%; /* Use full width */
                margin: 10px 0; /* Adjust margin */
            }
            .game-area {
                flex-direction: column;
                align-items: center;
                max-width: 100%;
                gap: 20px; /* Reduce gap */
            }

            .word-section {
                flex: none;
                width: 100%;
                 max-width: 300px; /* Limit width */
            }

            .word-card {
                width: 100%; /* Full width within section */
                height: 0; /* Reset height */
                 padding-bottom: 142%; /* Maintain aspect ratio (500/350) */
                 position: relative;
                margin-bottom: 20px; /* Add space below */
            }
             .word-card img { /* Adjust image position for aspect ratio */
                position: absolute;
                top: 5%;
                left: 5%;
                width: 90%;
                height: 90%;
             }


             .next-button {
                width: 80%; /* Make button wider */
             }


            .options-section {
                flex: none;
                width: 100%; /* Full width */
                max-width: 350px; /* Limit width slightly more */
            }

            .options-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px; /* Reduce gap */
                width: 100%; /* Ensure grid uses full section width */
            }

            .option-card {
                width: 100%; /* Make cards fill grid cells */
                height: 0; /* Reset height */
                padding-bottom: 127%; /* Maintain aspect ratio (280/220) */
                position: relative;
                min-height: unset; /* Remove min-height */
            }
            .option-card img { /* Adjust image position for aspect ratio */
                position: absolute;
                top: 5%;
                left: 5%;
                width: 90%;
                height: 90%;
            }
             .option-card.wrong::after, .option-card.selected-wrong::after {
                 /* Adjust cross position/size on smaller cards */
                  font-size: 24px;
                  width: 30px;
                  height: 30px;
                  top: 5px;
                  right: 5px;
             }
              .option-card.selected-wrong::after {
                  /* Keep large cross centered for selected wrong */
                 font-size: 60px;
                 top: 50%;
                 left: 50%;
                 transform: translate(-50%, -50%);

              }


            .seat-grid {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); /* More responsive seats */
                gap: 10px;
                max-width: 100%;
            }

            .seat-button {
                width: 100%; /* Full width of grid cell */
                height: 0;
                padding-bottom: 100%; /* Make it square */
                position: relative;
                font-size: 1.2rem;
            }
             .seat-button span { /* Center number in square */
                 position: absolute;
                 top: 50%;
                 left: 50%;
                 transform: translate(-50%, -50%);
             }


            .analysis-title {
                font-size: 2rem;
            }
            .analysis-content-wrapper {
                 padding: 0 10px; /* Add slight padding on mobile */
            }
            .analysis-card {
                padding: 20px;
            }
             .analysis-card h3 {
                font-size: 1.2rem;
             }
             .analysis-card p, .suggestion-list li {
                 font-size: 1rem;
             }

            .stats-container {
                flex-direction: column; /* Stack stats cards */
                gap: 15px;
            }
            .stat-card {
                min-width: unset; /* Remove min-width */
                width: 100%; /* Full width */
            }

            .modal-content {
                width: 90%;
                padding: 20px;
            }
             .modal-buttons {
                 gap: 10px;
             }
             .teacher-button, .restart-button, .next-button {
                 padding: 12px 30px;
                 font-size: 1.1rem;
             }
             .fullscreen-btn {
                 top: 15px;
                 right: 15px;
                 width: 40px;
                 height: 40px;
             }
             .fullscreen-btn svg {
                width: 20px;
                height: 20px;
             }
             .progress-dot {
                 width: 35px;
                 height: 35px;
                 font-size: 28px;
             }
             .game-header {
                 margin-bottom: 20px;
             }

        }

        @media (max-width: 480px) {
             .game-title {
                 font-size: 1.8rem; /* Further reduce title size */
             }
             .word-card {
                 /* Height adjusted by aspect ratio */
                 margin-bottom: 15px;
             }
             .options-grid {
                 gap: 8px; /* Further reduce gap */
             }
             .option-card {
                  /* Height adjusted by aspect ratio */
             }

             .seat-grid {
                grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); /* Smaller seat buttons */
                gap: 8px;
            }
            .seat-button {
                 font-size: 1rem; /* Smaller font size for seats */
            }

            .teacher-button, .restart-button, .next-button {
                 padding: 10px 25px;
                 font-size: 1rem;
             }
             .analysis-title {
                 font-size: 1.8rem;
             }
              .analysis-card {
                padding: 15px;
             }
             .analysis-card h3 {
                 font-size: 1.1rem;
             }
              .modal-content {
                 padding: 15px 20px;
             }
              .modal-content h2 {
                 font-size: 1.5rem;
              }


        }
    </style>
</head>
<body>
    <div class="game-container">
        <button id="fullscreenBtn" class="fullscreen-btn" title="ÂÖ®Ëû¢ÂπïÂàáÊèõ">
            <svg id="enterFsIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
            <svg id="exitFsIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>
        </button>
        <!-- Â∫ßËôüÈÅ∏ÊìáÁï´Èù¢ -->
        <div class="seat-selection-screen" id="seatSelectionScreen">
            <h1 class="seat-selection-title">üë• Ë´ãÈÅ∏ÊìáÂ≠∏ÁîüÂ∫ßËôü</h1>
            <div class="seat-grid" id="seatGrid">
                <!-- Â∫ßËôüÊåâÈàïÊúÉÂãïÊÖãÁîüÊàê -->
            </div>
            <div class="teacher-controls">
                <button class="teacher-button" onclick="showAnalysis()">üìä ÂÖ®Áè≠Â≠∏ÁøíÂàÜÊûê</button>
                <button class="teacher-button" onclick="resetAllProgress()">üîÑ ÈáçÁΩÆÂÖ®Áè≠ÈÄ≤Â∫¶</button>
            </div>
        </div>

        <!-- ÈÅäÊà≤Áï´Èù¢ (Initially Hidden) -->
        <div class="game-header" id="gameHeader" style="display: none;">
            <h1 class="game-title">üéØ Ë™ûÊñáÈóñÈóúË∂£(‰∏≠Áè≠)</h1>
            <div class="current-student" id="currentStudent" style="font-size: 1.3rem; color: #6B9BD1; margin-bottom: 20px;"></div>
            <div class="progress-dots" id="progressDots">
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
            </div>
            <div class="question-counter" id="questionCounter">Á¨¨ 1 È°å / 5 È°å</div>
        </div>

        <div id="gameArea" class="game-area" style="display: none;">
            <div class="word-section">
                <div class="word-card">
                    <img id="wordImage" class="word-image" src="" alt="Ë™ûË©ûÂúñÁâá">
                </div>
                 <button class="next-button" id="nextButton" onclick="nextQuestion()">‰∏ã‰∏ÄÈ°å ‚û°Ô∏è</button>
            </div>

            <div class="options-section">
                <div class="options-grid" id="optionsGrid">
                    <!-- ÈÅ∏È†ÖÊúÉÂãïÊÖãÁîüÊàê -->
                </div>
            </div>
        </div>

        <!-- ÂÆåÊàêÁï´Èù¢ (Initially Hidden) -->
        <div class="completion-screen" id="completionScreen" style="display: none;">
            <div class="completion-title">üéâ ÊÅ≠ÂñúÂÆåÊàêÔºÅ</div>
            <div class="score-display" id="scoreDisplay">‰Ω†Á≠îÂ∞ç‰∫Ü 5 È°å‰∏≠ÁöÑ 5 È°åÔºÅ</div>
            <button class="restart-button" onclick="backToSeatSelection()">ËøîÂõûÂ∫ßËôüÈÅ∏Êìá üîô</button>
        </div>

        <!-- ÂÖ®Áè≠ÂàÜÊûêÁï´Èù¢ (Initially Hidden) -->
        <div class="analysis-screen" id="analysisScreen" style="display: none;">
            <div class="analysis-title">üìä ÂÖ®Áè≠Â≠∏ÁøíÂàÜÊûêÂ†±Âëä</div>
             <div class="teacher-controls" style="border-top: none; padding-top: 0; margin-bottom: 20px; text-align: center;">
                 <button class="teacher-button" onclick="openExportModal()">üöÄ ÂåØÂá∫Â†±Âëä</button>
             </div>
            <div class="analysis-content-wrapper" id="analysisContent">
                {/* ÂàÜÊûêÂÖßÂÆπÂç°ÁâáÊúÉÂãïÊÖãÁîüÊàê */}
            </div>
             <div style="text-align: center;">
                 <button class="teacher-button" onclick="backToSeatSelection()" style="margin-top: 20px;">ËøîÂõûÂ∫ßËôüÈÅ∏Êìá</button>
             </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loader"></div>
        <p style="margin-top: 20px; font-size: 1.2rem; color: #555;">Ê≠£Âú®Áî¢ÁîüÂ†±Âëä‰∏≠...</p>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>ÂåØÂá∫Â≠∏ÁøíÂ†±Âëä</h2>
            <p>Ë´ãËº∏ÂÖ•ÂúíÊâÄËàáÁè≠Á¥öÂêçÁ®±Ôºö</p>
            <input type="text" id="exportSchoolName" placeholder="ÂúíÊâÄÂêçÁ®±">
            <input type="text" id="exportClassName" placeholder="Áè≠Á¥öÂêçÁ®±">
            <div class="modal-buttons">
                <button class="teacher-button" onclick="exportAnalysis('pdf')">üìÑ ÂåØÂá∫PDF</button>
                <button class="teacher-button" onclick="exportAnalysis('png')">üñºÔ∏è ÂåØÂá∫ÂúñÁâá</button>
                <button class="teacher-button cancel" onclick="closeExportModal()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <script>
        const gameData = [
             // ... (gameData array remains the same as provided before) ...
             { name: 'ÂñáÂè≠', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-01.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-01.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-01.jpg' },
             { name: 'Ë∂¥Ëëó', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-02.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-02.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-02.jpg' },
             { name: 'Â™ΩÂ™Ω', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-03.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-03.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-03.jpg' },
             { name: 'ÁöÆËÜö', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-04.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-04.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-04.jpg' },
             { name: 'ÂàÄÂ≠ê', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-05.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-05.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-05.jpg' },
             { name: 'Ê°ÉÂ≠ê', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-06.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-06.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-06.jpg' },
             { name: 'Â∞èÁâõ', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-07.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-07.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-07.jpg' },
             { name: 'Âø´Ê®Ç', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-08.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-08.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-08.jpg' },
             { name: 'Âî±Ê≠å', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-09.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-09.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-09.jpg' },
             { name: '‰∏ÄÊ£µ', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-10.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-10.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-10.jpg' },
             { name: 'ÂñùÊ∞¥', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-11.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-11.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-11.jpg' },
             { name: 'È£õÊ©ü', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-12.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-12.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-12.jpg' },
             { name: 'Ê≤πÊºÜ', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-13.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-13.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-13.jpg' },
             { name: 'Ë•øÁìú', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-14.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-14.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-14.jpg' },
             { name: 'Â∞èË±¨', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-15.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-15.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-15.jpg' },
             { name: 'Âá∫‰æÜ', wordImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-16.jpg', pictureImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/20250805-16.png', phoneticImage: 'https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Middle-01/2025-1009-16.jpg' }
        ];

        let currentQuestion = 0;
        let score = 0;
        let gameQuestions = [];
        let answered = false;
        let currentStudentSeat = null;
        let studentProgress = JSON.parse(localStorage.getItem('studentProgress') || '{}');
        let currentAttemptCorrectness = []; // To track correctness for the current attempt

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function initSeatSelection() {
            const seatGrid = document.getElementById('seatGrid');
            seatGrid.innerHTML = '';

            for (let i = 1; i <= 25; i++) {
                const seatButton = document.createElement('div');
                seatButton.className = 'seat-button';
                // Add a span inside for centering content with aspect ratio method
                const numberSpan = document.createElement('span');
                numberSpan.textContent = i;
                seatButton.appendChild(numberSpan);
                seatButton.dataset.seatNumber = i; // Store number for styling or later use if needed
                seatButton.onclick = () => selectSeat(i);

                if (studentProgress[i] && studentProgress[i].completed) {
                    seatButton.classList.add('completed');
                    seatButton.onclick = null; // Disable click if completed
                }

                seatGrid.appendChild(seatButton);
            }
        }


        function selectSeat(seatNumber) {
            currentStudentSeat = seatNumber;
            document.getElementById('seatSelectionScreen').style.display = 'none';
            document.getElementById('analysisScreen').style.display = 'none';
            document.getElementById('gameHeader').style.display = 'block'; // Should show header
            document.getElementById('gameArea').style.display = 'flex'; // Should show game area
            document.getElementById('completionScreen').style.display = 'none'; // Ensure completion screen is hidden
            document.getElementById('currentStudent').textContent = `Â≠∏ÁîüÂ∫ßËôüÔºö${seatNumber} Ëôü`;
            initGame(); // Starts the game logic
        }

        function initGame() {
            const shuffledData = shuffleArray(gameData);
            gameQuestions = shuffledData.slice(0, 5); // Select 5 questions for the game

            currentQuestion = 0;
            score = 0;
            answered = false;
            currentAttemptCorrectness = new Array(gameQuestions.length).fill(null); // Reset correctness tracking

            document.getElementById('completionScreen').style.display = 'none';
            document.getElementById('nextButton').style.display = 'none';
             // Reset dots visual state at the start of a new game
            const dots = document.querySelectorAll('.progress-dot');
            dots.forEach(dot => dot.classList.remove('completed'));

            loadQuestion(); // Load the first question
        }

        function loadQuestion() {
            if (currentQuestion >= gameQuestions.length) {
                completeGame(); // Should not happen if logic is correct, but as a safeguard
                return;
            }

            answered = false; // Allow answering for the new question
            const questionData = gameQuestions[currentQuestion];

            updateDotProgress(); // Update the visual progress dots
            document.getElementById('questionCounter').textContent = `Á¨¨ ${currentQuestion + 1} È°å / ${gameQuestions.length} È°å`;

            // Display the main word image
            const wordImageElement = document.getElementById('wordImage');
             if (wordImageElement) {
                wordImageElement.src = questionData.wordImage;
                wordImageElement.alt = `Ë™ûË©ûÂúñÁâáÔºö${questionData.name}`; // More descriptive alt text
             }


            generateOptions(questionData); // Create the answer options

            document.getElementById('nextButton').style.display = 'none'; // Hide next button until answer

             // Ensure options are clickable and styles are reset
            const allOptions = document.querySelectorAll('.option-card');
            allOptions.forEach(card => {
                card.classList.remove('correct', 'wrong', 'selected-wrong');
                card.style.pointerEvents = 'auto'; // Re-enable clicking
                 card.style.opacity = '1'; // Reset opacity
                 card.style.filter = 'none'; // Reset filter
            });
        }

        function updateDotProgress() {
            const dots = document.querySelectorAll('.progress-dot');
            dots.forEach((dot, index) => {
                if (index < currentQuestion) {
                    dot.classList.add('completed');
                } else {
                    dot.classList.remove('completed');
                }
            });
        }

        function generateOptions(correctData) {
            const optionsGrid = document.getElementById('optionsGrid');
            optionsGrid.innerHTML = ''; // Clear previous options

            const isPhoneticQuestion = currentQuestion < 2; // First 2 questions use phonetic images

            // Get 3 different options
            const otherOptions = gameData.filter(item => item.name !== correctData.name);
            const shuffledOthers = shuffleArray(otherOptions).slice(0, 3);

            // Combine correct and incorrect options, then shuffle
            const options = [correctData, ...shuffledOthers];
            const shuffledOptions = shuffleArray(options);

            // Create and append option cards
            shuffledOptions.forEach((option) => {
                const optionCard = document.createElement('div');
                optionCard.className = 'option-card';
                optionCard.onclick = () => selectOption(optionCard, option.name === correctData.name);

                const img = document.createElement('img');
                img.className = 'option-image';
                img.src = isPhoneticQuestion ? option.phoneticImage : option.pictureImage;
                img.alt = option.name; // Use name for alt text
                 // Add error handling for images
                 img.onerror = () => { img.alt = 'ÂúñÁâáËºâÂÖ•Â§±Êïó'; /* Optionally show placeholder */ };


                optionCard.appendChild(img);
                optionsGrid.appendChild(optionCard);
            });
        }


        function createConfetti() {
            const confettiContainer = document.querySelector('.game-container');
             const existingConfetti = confettiContainer.querySelector('.confetti');
             if (existingConfetti) {
                 confettiContainer.removeChild(existingConfetti);
             }

            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confettiContainer.appendChild(confetti);

            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = Math.random() * 100 + '%';
                piece.style.animationDelay = Math.random() * 2 + 's';
                piece.style.animationDuration = (Math.random() * 2 + 1.5) + 's';
                 const randomColor = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'][Math.floor(Math.random() * 5)];
                 piece.style.background = randomColor;
                 if (Math.random() > 0.7) piece.style.borderRadius = '50%';
                 if (Math.random() < 0.3) piece.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.appendChild(piece);
            }

            setTimeout(() => {
                 // Check parentNode before removing, in case container changed
                 if (confetti.parentNode === confettiContainer) {
                    confettiContainer.removeChild(confetti);
                 }
            }, 4000);
        }

        function selectOption(selectedCard, isCorrect) {
            if (answered) return;
            answered = true;
            currentAttemptCorrectness[currentQuestion] = isCorrect; // Record correctness for this attempt

            const allOptions = document.querySelectorAll('.option-card');
            allOptions.forEach(card => card.style.pointerEvents = 'none');

            if (isCorrect) {
                selectedCard.classList.add('correct');
                score++;
                createConfetti();
                setTimeout(() => {
                    if (currentQuestion < gameQuestions.length - 1) {
                        nextQuestion();
                    } else {
                        completeGame();
                    }
                }, 1500);
            } else {
                const correctData = gameQuestions[currentQuestion];
                const isPhoneticQuestion = currentQuestion < 2;
                allOptions.forEach(card => {
                    const img = card.querySelector('.option-image');
                    const correctSrc = isPhoneticQuestion ? correctData.phoneticImage : correctData.pictureImage;
                    if (img && img.src === correctSrc) {
                        card.classList.add('correct');
                    } else if (card === selectedCard) {
                        card.classList.add('selected-wrong');
                    } else {
                        card.classList.add('wrong');
                    }
                });
                setTimeout(() => {
                    if (currentQuestion < gameQuestions.length - 1) {
                        document.getElementById('nextButton').style.display = 'block';
                    } else {
                        completeGame();
                    }
                }, 1500);
            }
        }

        function nextQuestion() {
            currentQuestion++;
            // Check if game should end
             if (currentQuestion >= gameQuestions.length) {
                 completeGame();
             } else {
                 loadQuestion(); // Load the next question
             }
        }

         function completeGame() {
            // Save progress
            if (currentStudentSeat !== null) {
                 const attemptQuestions = gameQuestions.map((q, index) => ({
                     word: q.name,
                     correct: currentAttemptCorrectness[index] === true // Use recorded correctness
                 }));

                studentProgress[currentStudentSeat] = {
                    completed: true,
                    score: score,
                    totalQuestions: gameQuestions.length,
                    completedAt: new Date().toISOString(),
                    questions: attemptQuestions // Store questions with tracked correctness
                };
                localStorage.setItem('studentProgress', JSON.stringify(studentProgress));
            }

            // Update final dot visually
             const dots = document.querySelectorAll('.progress-dot');
             dots.forEach(dot => dot.classList.add('completed')); // Mark all as completed

            // Show completion screen
            setTimeout(() => {
                document.getElementById('gameArea').style.display = 'none';
                document.getElementById('gameHeader').style.display = 'none';
                document.getElementById('scoreDisplay').textContent = `${currentStudentSeat}ËôüÂêåÂ≠∏ Á≠îÂ∞ç‰∫Ü ${gameQuestions.length} È°å‰∏≠ÁöÑ ${score} È°åÔºÅ`;
                document.getElementById('completionScreen').style.display = 'block';
            }, 1000); // Wait after last question feedback
        }

        function backToSeatSelection() {
            // Hide all game/result screens
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameHeader').style.display = 'none';
            document.getElementById('completionScreen').style.display = 'none';
            document.getElementById('analysisScreen').style.display = 'none';
            // Show seat selection
            document.getElementById('seatSelectionScreen').style.display = 'block';
            initSeatSelection(); // Refresh seat statuses
        }

        function showAnalysis() {
            document.getElementById('seatSelectionScreen').style.display = 'none';
            // Ensure other screens are hidden
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameHeader').style.display = 'none';
            document.getElementById('completionScreen').style.display = 'none';
            // Show analysis
            document.getElementById('analysisScreen').style.display = 'block';
            generateAnalysisReport(); // Generate the report content
        }

         // --- generateAnalysisReport Function (with previous card layout & score display fixes) ---
        function generateAnalysisReport() {
            const analysisContentWrapper = document.getElementById('analysisContent');
            analysisContentWrapper.innerHTML = ''; // Clear previous content

            const completedStudents = Object.keys(studentProgress).filter(seat => studentProgress[seat] && studentProgress[seat].completed);
            const totalStudentsCount = 25; // Keep for reference if needed elsewhere, but don't display directly
            const completedCount = completedStudents.length;

            let totalScore = 0;
            const wordErrorStats = {}; // { wordName: { attempts: 0, errors: 0 } }

            completedStudents.forEach(seat => {
                const progress = studentProgress[seat];
                 if (typeof progress.score === 'number') { // Check if score is valid
                    totalScore += progress.score;
                 }


                // Aggregate word errors ONLY from completed students
                 if (progress.questions && Array.isArray(progress.questions)) {
                     progress.questions.forEach((q) => {
                         if (!q || !q.word) return; // Skip invalid question data
                         if (!wordErrorStats[q.word]) {
                             wordErrorStats[q.word] = { attempts: 0, errors: 0 };
                         }
                         wordErrorStats[q.word].attempts++;
                         // Use the stored 'correct' flag
                         if (q.correct === false) { // Explicitly check for false
                             wordErrorStats[q.word].errors++;
                         }
                     });
                 }
            });

            // Calculate average score based *only* on completed students
            const averageScorePercent = completedCount > 0
                ? Math.round((totalScore / (completedCount * gameQuestions.length)) * 100) // Use actual number of questions
                : 0;

            let learningStatusText = 'Â∞öÁÑ°Ë≥áÊñô';
            if (completedCount > 0) {
                if (averageScorePercent >= 80) {
                    learningStatusText = 'Ë°®ÁèæÂÑ™Áï∞';
                } else if (averageScorePercent >= 60) {
                    learningStatusText = 'Ë°®ÁèæËâØÂ•Ω';
                } else {
                    learningStatusText = 'ÂÜçÊé•ÂÜçÂé≤';
                }
            }

            // Find words with >= 50% error rate among completed students' attempts
             const highErrorWords = Object.entries(wordErrorStats)
                .filter(([word, stats]) => stats.attempts > 0 && (stats.errors / stats.attempts) >= 0.5)
                .map(([word, stats]) => word); // Get only the word name


            // --- Build HTML using Card Structure ---

            // 1. Overall Status Card
            const overallCard = document.createElement('div');
            overallCard.className = 'analysis-card';
            overallCard.innerHTML = `
                <h3>üìà Êï¥È´îÊ¶ÇÊ≥Å</h3>
                <p><strong>Â∑≤ÂÆåÊàê‰∫∫Êï∏Ôºö</strong> ${completedCount} ‰∫∫</p>
                <p><strong>ÂÖ®Áè≠Â≠∏ÁøíÁãÄÊ≥ÅÔºö</strong> ${learningStatusText}</p>
                <p><strong>Â†±ÂëäÊó•ÊúüÔºö</strong> ${new Date().toLocaleDateString('zh-TW')}</p>
            `;
            analysisContentWrapper.appendChild(overallCard);

            // 2. Statistics Card (Container for two smaller cards)
            const statsCardContainer = document.createElement('div');
            statsCardContainer.className = 'analysis-card'; // Outer card shell
             statsCardContainer.innerHTML = `<h3>üìä Áµ±Ë®àÊï∏Êìö</h3>`; // Title for the stats section

             const statsContainerInner = document.createElement('div');
             statsContainerInner.className = 'stats-container'; // Flex container

             // Left Stat Card
            const completedStatCard = document.createElement('div');
            completedStatCard.className = 'stat-card';
            completedStatCard.innerHTML = `
                <div class="stat-card-title">Â∑≤ÂÆåÊàê‰∫∫Êï∏</div>
                <div class="stat-card-value">${completedCount}</div>
            `;
             statsContainerInner.appendChild(completedStatCard);

            // Right Stat Card
            const statusStatCard = document.createElement('div');
            statusStatCard.className = 'stat-card';
            statusStatCard.innerHTML = `
                <div class="stat-card-title">ÂÖ®Áè≠Â≠∏ÁøíÁãÄÊ≥Å</div>
                <div class="stat-card-value">${learningStatusText}</div>
            `;
            statsContainerInner.appendChild(statusStatCard);

            statsCardContainer.appendChild(statsContainerInner); // Add inner container to the card
            analysisContentWrapper.appendChild(statsCardContainer); // Add the whole stats card


            // 3. High Error Words Card (Conditional)
             const errorWordsCard = document.createElement('div'); // Create card regardless
             errorWordsCard.className = 'analysis-card';
             let errorWordsContent = '';

             if (completedCount > 0) { // Check if data exists
                 if (highErrorWords.length > 0) {
                     errorWordsContent = `
                         <div class="error-words-grid">
                             ${highErrorWords.map(word => `<div class="error-word-item">${word}</div>`).join('')}
                         </div>`;
                 } else {
                     errorWordsContent = '<p>ÂÖ®Áè≠Âú®Ê≠§Ê¨°Ê∏¨È©ó‰∏≠ÂùáË°®ÁèæËâØÂ•ΩÔºåÊ≤íÊúâÁ≠îÈåØÁéáÂÅèÈ´òÁöÑË™ûË©ûÔºÅ</p>';
                 }
             } else {
                  errorWordsContent = '<p>Â∞öÁÑ°Â≠∏ÁîüÂÆåÊàêÊ∏¨È©óÔºåÁÑ°Ê≥ïÂàÜÊûê„ÄÇ</p>';
             }

             errorWordsCard.innerHTML = `
                <h3>‚ö†Ô∏è ÂæÖÂä†Âº∑Ë™ûË©û</h3>
                ${errorWordsContent}
             `;
             analysisContentWrapper.appendChild(errorWordsCard);


            // 4. Suggestions Card
            const suggestionsCard = document.createElement('div');
            suggestionsCard.className = 'analysis-card';
            suggestionsCard.innerHTML = `
                <h3>üìù ÊïôÂ≠∏Âª∫Ë≠∞</h3>
                <ul class="suggestion-list">
                    <li>ÈáùÂ∞çÁ≠îÈåØÁéáËºÉÈ´òÁöÑË™ûË©ûÔºåÂèØË®≠Ë®àÈ°çÂ§ñÂä†Âº∑Ê¥ªÂãï„ÄÇ</li>
                    <li>Ëã•Êï¥È´îÁãÄÊ≥ÅÁÇ∫„ÄåÂÜçÊé•ÂÜçÂé≤„ÄçÔºåÂª∫Ë≠∞ÂÆâÊéíË§áÁøíË™≤Á®ãÊàñË™øÊï¥ÊïôÂ≠∏Ê≠•Ë™ø„ÄÇ</li>
                    <li>ÂèØ‰ª•Âà©Áî®ÂúñÂç°ÈÖçÂ∞ç„ÄÅË≥ìÊûúÈÅäÊà≤Á≠âÊñπÂºèÂ¢ûÂä†Ë∂£Âë≥ÊÄß„ÄÇ</li>
                    <li>ÈºìÂãµ„ÄåË°®ÁèæÂÑ™Áï∞„ÄçÁöÑÂêåÂ≠∏Êìî‰ªªÂ∞èËÄÅÂ∏´ÔºåÂçîÂä©ÂÖ∂‰ªñÂêåÂ≠∏„ÄÇ</li>
                    <li>ËßÄÂØüÂ≠∏Áîü‰ΩúÁ≠îÁãÄÊ≥ÅÔºå‰∫ÜËß£ÊòØÊãºÈü≥ÂïèÈ°åÈÇÑÊòØË≠òÂúñÂïèÈ°å„ÄÇ</li>
                </ul>
            `;
            analysisContentWrapper.appendChild(suggestionsCard);
        }
         // --- END of Analysis Function ---


        function resetAllProgress() {
            // Use a confirmation dialog (replace window.confirm in production)
            if (window.confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆÂÖ®Áè≠ÈÄ≤Â∫¶ÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                localStorage.removeItem('studentProgress');
                studentProgress = {}; // Reset in-memory data
                initSeatSelection(); // Refresh the seat selection screen
                // Consider adding a subtle visual feedback message instead of alert
            }
        }

        function openExportModal() {
             const modal = document.getElementById('exportModal');
             modal.style.display = 'flex'; // Show overlay
             // Use setTimeout to allow the display change to render before adding 'visible'
             setTimeout(() => {
                 modal.classList.add('visible');
             }, 10); // Small delay

            document.getElementById('exportSchoolName').value = ''; // Clear fields
            document.getElementById('exportClassName').value = '';
            // Clear any previous error states
            document.getElementById('exportSchoolName').style.borderColor = '';
            document.getElementById('exportClassName').style.borderColor = '';
        }

        function closeExportModal() {
             const modal = document.getElementById('exportModal');
             modal.classList.remove('visible');
             // Wait for transition to finish before setting display: none
             modal.addEventListener('transitionend', () => {
                 modal.style.display = 'none';
             }, { once: true }); // Ensure listener is removed after firing once
        }


        function exportAnalysis(format) {
            const schoolNameInput = document.getElementById('exportSchoolName');
            const classNameInput = document.getElementById('exportClassName');
            const schoolName = schoolNameInput.value.trim();
            const className = classNameInput.value.trim();

            // Simple validation
            let hasError = false;
            if (!schoolName) {
                schoolNameInput.style.borderColor = 'red'; hasError = true;
            } else { schoolNameInput.style.borderColor = ''; }
             if (!className) {
                classNameInput.style.borderColor = 'red'; hasError = true;
            } else { classNameInput.style.borderColor = ''; }
            if (hasError) return;

            closeExportModal();

            const analysisContentElement = document.getElementById('analysisContent');
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

             // Temporarily add a header for the export
            const reportHeader = document.createElement('div');
            reportHeader.className = 'report-header';
            reportHeader.innerHTML = `<h2>${schoolName}</h2><p>${className} - Ê≥®Èü≥ÈÖçÂ∞çÈÅäÊà≤Â≠∏ÁøíÂàÜÊûêÂ†±Âëä</p>`;
            analysisContentElement.prepend(reportHeader);


            // Use html2canvas
            html2canvas(analysisContentElement, {
                 scale: 2, useCORS: true, backgroundColor: '#F0F4F8'
             }).then(canvas => {
                const filenameBase = `${schoolName}-${className}-Â≠∏ÁøíÂ†±Âëä`;

                if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const margin = 10;
                    const contentWidth = pdfWidth - margin * 2;
                    const canvasAspectRatio = canvas.height / canvas.width;
                    const contentHeight = contentWidth * canvasAspectRatio;
                    let pageHeight = pdfHeight - margin * 2;
                    let heightLeft = contentHeight;
                    let position = margin;

                    pdf.addImage(imgData, 'PNG', margin, position, contentWidth, contentHeight);
                    heightLeft -= pageHeight;
                    while (heightLeft > 0) {
                        position = heightLeft - contentHeight + margin;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', margin, position, contentWidth, contentHeight);
                        heightLeft -= pageHeight;
                    }
                    pdf.save(`${filenameBase}.pdf`);
                } else if (format === 'png') {
                    const link = document.createElement('a');
                    link.download = `${filenameBase}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }

                analysisContentElement.removeChild(reportHeader);
                loadingOverlay.style.display = 'none';

            }).catch(err => {
                console.error("ÂåØÂá∫Â§±Êïó:", err);
                if (analysisContentElement.contains(reportHeader)) {
                    analysisContentElement.removeChild(reportHeader);
                }
                loadingOverlay.style.display = 'none';
                 // Inform user of failure (replace alert)
                 alert('Â†±ÂëäÂåØÂá∫Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ'); // Replace alert with a better UI element
            });
        }

        // Fullscreen Toggle Logic
        function toggleFullScreen() {
             const doc = window.document;
             const docEl = doc.documentElement;
             const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
             const cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;
             const isFullscreen = !(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement);

             if (!isFullscreen) {
               if (requestFullScreen) requestFullScreen.call(docEl);
             } else {
                if (cancelFullScreen) cancelFullScreen.call(doc);
             }
         }

        function updateFullscreenIcon() {
            const enterIcon = document.getElementById('enterFsIcon');
            const exitIcon = document.getElementById('exitFsIcon');
             // Check across browsers
            const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
            if (isFullscreen) {
                if(enterIcon) enterIcon.style.display = 'none';
                if(exitIcon) exitIcon.style.display = 'block';
            } else {
                if(enterIcon) enterIcon.style.display = 'block';
                if(exitIcon) exitIcon.style.display = 'none';
            }
        }


        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initSeatSelection();
            document.addEventListener('contextmenu', event => event.preventDefault());
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn) fullscreenBtn.addEventListener('click', toggleFullScreen);
             document.addEventListener('fullscreenchange', updateFullscreenIcon);
             document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
             document.addEventListener('mozfullscreenchange', updateFullscreenIcon);
             document.addEventListener('MSFullscreenChange', updateFullscreenIcon);
             updateFullscreenIcon(); // Set initial state
        });

    </script>
</body>
</html>

