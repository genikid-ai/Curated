<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語詞魔法師</title>
    <!-- 匯出 PDF 和圖片所需套件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #faf8f3 0%, #f5f1e8 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-container {
            background: #fefcf8;
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.15);
            text-align: center;
            max-width: 1000px;
            width: 100%;
            border: 2px solid #e6d7c3;
            position: relative; /* 為了全螢幕按鈕定位 */
        }
        
        .fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #fefcf8;
            border: 2px solid #e6d7c3;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #8b4513;
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .fullscreen-btn:hover {
            background: #f5f1e8;
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.1);
            transform: scale(1.05);
        }
        
        .fullscreen-btn svg {
            width: 24px;
            height: 24px;
            stroke: #8b4513;
        }

        .game-layout {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            justify-content: center;
            margin-top: 30px;
        }

        .left-section {
            flex: 1;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .right-section {
            flex: 1;
            max-width: 400px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .card-display {
            width: 280px;
            height: 400px;
            border: 5px dashed #deb887;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f6f0;
            color: #8b6914;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 30px;
        }

        .card-display.active {
            border: 5px solid #deb887;
            background: #fefcf8;
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.2);
        }

        .displayed-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }

        .game-title {
            color: #8b4513;
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 25px;
            text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.1);
            letter-spacing: 1px;
        }

        .progress-icons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .progress-icon {
            font-size: 2.5rem;
            transition: all 0.3s ease;
            color: #d2b48c;
            filter: grayscale(100%);
        }

        .progress-icon.completed {
            color: #daa520;
            filter: none;
        }

        .progress-icon.current {
            color: #b8860b;
            filter: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .question-counter {
            font-size: 1.5rem;
            color: #4a5568;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .card-container {
            perspective: 1000px;
            width: 280px;
            height: 400px;
            position: relative;
            z-index: 50;
            margin-top: 30px;
        }

        .card-stack {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .stack-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f5dc 0%, #deb887 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #374151;
            font-size: 3rem;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: 2px solid #d4af37;
        }

        .stack-card:nth-child(1) {
            transform: translate(-8px, -8px) rotate(-2deg);
            z-index: 1;
            opacity: 0.7;
        }

        .stack-card:nth-child(2) {
            transform: translate(-4px, -4px) rotate(-1deg);
            z-index: 2;
            opacity: 0.85;
        }

        .stack-card:nth-child(3) {
            transform: translate(0px, 0px) rotate(0deg);
            z-index: 3;
            opacity: 1;
        }

        .shuffle-cards {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .shuffle-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f5dc 0%, #deb887 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #374151;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            opacity: 0;
        }

        .shuffle-animation {
            animation: shuffleCard 0.8s ease-in-out forwards;
        }

        @keyframes shuffleCard {
            0% {
                opacity: 1;
                transform: translateX(0) translateY(0) rotate(0deg) scale(1);
            }
            25% {
                opacity: 1;
                transform: translateX(-100px) translateY(-50px) rotate(-15deg) scale(0.9);
            }
            50% {
                opacity: 1;
                transform: translateX(100px) translateY(-30px) rotate(15deg) scale(0.9);
            }
            75% {
                opacity: 1;
                transform: translateX(-50px) translateY(20px) rotate(-8deg) scale(0.95);
            }
            100% {
                opacity: 0;
                transform: translateX(0) translateY(0) rotate(0deg) scale(1);
            }
        }

        .game-container.shuffling .card {
            opacity: 0;
        }

        .game-container.shuffling .question-counter,
        .game-container.shuffling .teacher-controls {
            opacity: 0.3;
        }

        .card {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            transform-style: preserve-3d;
            cursor: pointer;
            z-index: 100;
        }

        .flipping-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 300;
            transform-origin: center center;
            animation: naturalFlip 1.4s ease-in-out forwards;
            background: linear-gradient(135deg, #f5f5dc 0%, #deb887 100%);
            color: #374151;
            font-size: 3rem;
            font-weight: bold;
        }

        .flipping-page.show-content {
            background: white;
            border: 3px solid #e2e8f0;
            color: initial;
            font-size: initial;
            font-weight: initial;
        }

        @keyframes naturalFlip {
            0% {
                transform: rotateY(0deg) rotateX(0deg) scale(1);
                opacity: 1;
            }
            20% {
                transform: rotateY(20deg) rotateX(-5deg) scale(1.02);
                opacity: 1;
            }
            50% {
                transform: rotateY(90deg) rotateX(-10deg) scale(1.05);
                opacity: 1;
            }
            80% {
                transform: rotateY(160deg) rotateX(-5deg) scale(1.02);
                opacity: 1;
            }
            100% {
                transform: rotateY(180deg) rotateX(0deg) scale(1);
                opacity: 0;
            }
        }

        .flying-card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 100;
            pointer-events: none;
            opacity: 0;
        }



        .fly-to-right {
            animation: flyToRight 1s ease-in-out forwards;
        }

        @keyframes flyToRight {
            0% {
                opacity: 1;
                transform: translateX(0) translateY(0) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateX(200px) translateY(-20px) scale(0.8);
            }
            100% {
                opacity: 0;
                transform: translateX(400px) translateY(0) scale(1);
            }
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-back {
            background: linear-gradient(135deg, #f5f5dc 0%, #deb887 100%);
            color: #374151;
            font-size: 3rem;
            font-weight: bold;
        }

        .card-front {
            background: white;
            transform: rotateY(180deg);
            border: 3px solid #e2e8f0;
            flex-direction: column;
            padding: 20px;
        }

        .card-text {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2d3748;
        }

        .teacher-controls {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .teacher-controls.show {
            display: flex;
        }

        .teacher-controls h3 {
            margin: 0 !important;
            color: #8b4513;
            font-size: 1.2rem;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 12px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .control-btn:disabled:hover {
            transform: none !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .correct-btn {
            background: white;
            color: #16a34a;
            border: 3px solid #16a34a;
        }

        .correct-btn:hover {
            transform: scale(1.05);
            background: #f0fdf4;
            box-shadow: 0 6px 20px rgba(22, 163, 74, 0.2);
        }

        .wrong-btn {
            background: white;
            color: #dc2626;
            border: 3px solid #dc2626;
        }

        .wrong-btn:hover {
            transform: scale(1.05);
            background: #fef2f2;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.2);
        }

        .next-btn {
            background: linear-gradient(135deg, #deb887, #d2b48c);
            color: #8b4513;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            display: none;
        }

        .next-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(222, 184, 135, 0.4);
        }

        .completion-message {
            background: linear-gradient(135deg, #f4e4bc, #e6d7c3);
            color: #8b4513;
            padding: 30px;
            border-radius: 20px;
            margin-top: 30px;
            font-size: 1.5rem;
            font-weight: 600;
            display: none;
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.2);
            border: 2px solid #deb887;
        }

        .restart-btn {
            background: linear-gradient(135deg, #daa520, #b8860b);
            color: #fefcf8;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(218, 165, 32, 0.4);
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup-message {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: all 0.3s ease;
            max-width: 400px;
            width: 90%;
        }

        .popup-overlay.show .popup-message {
            transform: scale(1);
        }

        .popup-correct {
            border: 4px solid #48bb78;
        }

        .popup-correct .popup-icon {
            font-size: 4rem;
            color: #48bb78;
            margin-bottom: 20px;
        }

        .popup-correct .popup-text {
            font-size: 1.8rem;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 10px;
        }

        .popup-wrong {
            border: 4px solid #f56565;
        }

        .popup-wrong .popup-icon {
            font-size: 4rem;
            color: #f56565;
            margin-bottom: 20px;
        }

        .popup-wrong .popup-text {
            font-size: 1.8rem;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 10px;
        }

        .student-selection {
            text-align: center;
            padding: 20px;
        }

        .selection-title {
            color: #8b4513;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .seat-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 0 auto 30px auto;
        }

        .seat-btn {
            width: 80px;
            height: 60px;
            border: 3px solid #deb887;
            border-radius: 12px;
            background: linear-gradient(135deg, #fefcf8, #f9f6f0);
            color: #8b4513;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .seat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(222, 184, 135, 0.4);
            background: linear-gradient(135deg, #f9f6f0, #f4e4bc);
        }

        .seat-btn.completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
            color: #155724;
        }

        .seat-btn.completed::after {
            content: ' ✓';
            color: #28a745;
        }

        .seat-btn.completed:hover {
            transform: none;
            cursor: not-allowed;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .class-controls {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .class-analysis-btn {
            background: linear-gradient(135deg, #6f42c1, #5a32a3);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 200px;
        }

        .class-analysis-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.4);
        }

        .class-reset-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 200px;
        }

        .class-reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }

        .current-student {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #e8f4f8, #d1ecf1);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #bee5eb;
        }

        .student-info {
            color: #0c5460;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .back-to-selection-btn {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-to-selection-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .analysis-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .analysis-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .analysis-modal {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: all 0.3s ease;
        }

        .analysis-overlay.show .analysis-modal {
            transform: scale(1);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 2px solid #e9ecef;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 20px 20px 0 0;
            gap: 15px; /* 新增 */
        }

        .analysis-header h2 {
            margin: 0;
            color: #495057;
            font-size: 1.8rem;
            flex-grow: 1; /* 新增 */
            text-align: left; /* 新增 */
        }
        
        .analysis-header div { /* 新增 */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-analysis-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-analysis-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .analysis-content {
            padding: 30px;
        }

        .analysis-summary {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #28a745;
        }

        .analysis-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #dee2e6;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 1rem;
        }

        .student-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #dee2e6;
        }

        .student-list h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .completed-students {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .student-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        /* --- 新增匯出彈窗樣式 --- */
        .export-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* 較暗的背景 */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000; /* 確保在分析彈窗之上 */
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .export-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .export-modal {
            background: white;
            padding: 30px 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: all 0.3s ease;
            max-width: 450px;
            width: 90%;
        }

        .export-modal-overlay.show .export-modal {
            transform: scale(1);
        }
        
        .export-modal h3 {
            color: #8b4513;
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 25px;
        }
        
        .export-input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .export-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }
        
        .export-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #deb887;
            border-radius: 12px;
            font-size: 1.1rem;
            box-sizing: border-box; /* 確保 padding 不會破壞排版 */
        }
        
        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        
        .export-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .export-btn-pdf {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        .export-btn-pdf:hover {
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }
        
        .export-btn-png {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        .export-btn-png:hover {
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }
        
        .export-btn-cancel {
            background: #6c757d;
            color: white;
            margin-top: 10px;
        }
        .export-btn-cancel:hover {
            background: #5a6268;
        }
        
        /* 匯出時的讀取圖示 */
        .export-loading {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8b4513;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto 0 auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 用於產生 PDF/圖片 的暫存樣式 */
        .export-preview-container {
            position: absolute;
            left: -9999px; /* 移出畫面外 */
            top: 0;
            width: 800px; /* 固定寬度以統一 PDF 輸出 */
            background: #ffffff;
            padding: 40px;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            box-sizing: border-box;
        }
        .export-preview-container h2 {
            text-align: center;
            color: #8b4513;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .export-preview-container h3 {
             text-align: center;
            color: #4a5568;
            font-size: 1.5rem;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }
        /* 為 PDF 重新設定分析內容的樣式 */
        .export-preview-container .analysis-summary {
            background: #d4edda !important;
            border: 1px solid #28a745;
            color: #155724;
        }
        .export-preview-container .analysis-stats {
            grid-template-columns: repeat(2, 1fr); /* 強制兩欄 */
        }
        .export-preview-container .stat-card {
            background: #f8f9fa !important;
            border: 1px solid #dee2e6;
        }
        .export-preview-container .student-list {
            background: #fff3cd !important;
            border: 1px solid #ffc107;
        }
        .export-preview-container [style*="background: linear-gradient"] {
            background: none !important; /* 移除漸層 */
        }
        .export-preview-container [style*="#e3f2fd"] { /* 學習建議 */
            background: #e3f2fd !important;
            border: 1px solid #2196f3;
        }
        .export-preview-container ul {
            text-align: left;
            padding-left: 25px;
        }
        /* --- 樣式結束 --- */


        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .game-layout {
                flex-direction: column;
                gap: 20px;
            }
            
            .left-section, .right-section {
                max-width: 100%;
            }
            
            .card-container {
                width: 210px;
                height: 300px;
            }
            
            .card-display {
                width: 210px;
                height: 300px;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }

            .seat-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
            }

            .seat-btn {
                width: 60px;
                height: 50px;
                font-size: 1rem;
            }

            .current-student {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .analysis-modal {
                width: 95%;
                max-height: 90vh;
            }

            .analysis-header {
                padding: 20px;
                flex-direction: column; /* 窄螢幕時按鈕換行 */
                align-items: flex-start;
            }
            
            .fullscreen-btn {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
            
            .fullscreen-btn svg {
                width: 20px;
                height: 20px;
            }

            .analysis-content {
                padding: 20px;
            }

            .analysis-stats {
                grid-template-columns: 1fr;
            }

            .class-controls {
                flex-direction: column;
                gap: 15px;
            }

            .class-analysis-btn,
            .class-reset-btn {
                max-width: 100%;
            }
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <div class="game-container">
        <button id="fullscreenBtn" class="fullscreen-btn" onclick="toggleFullScreen()" title="全螢幕">
            <svg id="fs-enter-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
            <svg id="fs-exit-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><path d="M5 16H3v3a2 2 0 0 0 2 2h3v-2H5zM5 8H3V5a2 2 0 0 1 2-2h3v2H5zM19 8h2V5a2 2 0 0 0-2-2h-3v2h3zM19 16h2v3a2 2 0 0 1-2 2h-3v-2h3z"></path></svg>
        </button>
        
        <h1 class="game-title">🪄 語詞魔法師</h1>
        
        <!-- 學生座號選擇區域 -->
        <div class="student-selection" id="studentSelection">
            <h2 class="selection-title">👨‍🎓 請選擇學生座號</h2>
            <div class="seat-grid" id="seatGrid">
                <!-- 座號按鈕將由 JavaScript 生成 -->
            </div>
            <div class="class-controls">
                <button class="class-analysis-btn" id="classAnalysisBtn" onclick="showClassAnalysis()">
                    📊 全班學習分析
                </button>
                <button class="class-reset-btn" onclick="resetClassProgress()">
                    🔄 重製全班進度
                </button>
            </div>
        </div>
        
        <!-- 遊戲主要區域 -->
        <div class="game-main" id="gameMain" style="display: none;">
            <div class="current-student" id="currentStudent">
                <span class="student-info">👨‍🎓 座號 <span id="currentSeatNumber">1</span> 號同學</span>
                <button class="back-to-selection-btn" onclick="backToSelection()">← 返回選擇</button>
            </div>
        
        <div class="game-layout">
            <div class="left-section">
                <div class="progress-icons" id="progressIcons">
                    <div class="progress-icon current">⭐</div>
                    <div class="progress-icon">⭐</div>
                    <div class="progress-icon">⭐</div>
                    <div class="progress-icon">⭐</div>
                    <div class="progress-icon">⭐</div>
                </div>
                <div class="card-container">
                    <div class="card-stack" id="cardStack">
                        <div class="stack-card">🪄</div>
                        <div class="stack-card">🪄</div>
                        <div class="stack-card">🪄</div>
                    </div>
                    <div class="shuffle-cards" id="shuffleCards"></div>
                    <div class="card" id="gameCard" onclick="flipCard()">
                        <div class="card-face card-back">
                            <div>🪄</div>
                        </div>
                        <div class="card-face card-front" id="cardFront">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="right-section">
                <div class="teacher-controls" id="teacherControls">
                    <h3>👩‍🏫 老師判定</h3>
                    <div class="control-buttons">
                        <button class="control-btn correct-btn" onclick="markAnswer(true)" title="答對了">
                            ✓
                        </button>
                        <button class="control-btn wrong-btn" onclick="markAnswer(false)" title="答錯了">
                            ✗
                        </button>
                    </div>
                </div>
                <div class="card-display" id="cardDisplay">
                    <div>翻開卡片後會在這裡顯示</div>
                </div>
            </div>
        </div>
        

        
        <button class="next-btn" id="nextBtn" onclick="nextQuestion()">下一題 →</button>
        
        <div class="completion-message" id="completionMessage">
            🎉 恭喜完成！你已經學會了 5 個注音詞彙！
            <br>
            <button class="restart-btn" onclick="restartGame()">返回座號選擇</button>
        </div>
        </div> <!-- 關閉 game-main -->
    </div>

    <!-- 彈出提示窗 -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-message" id="popupMessage">
            <div class="popup-icon" id="popupIcon"></div>
            <div class="popup-text" id="popupText"></div>
        </div>
    </div>

    <!-- 全班分析彈窗 -->
    <div class="analysis-overlay" id="analysisOverlay">
        <div class="analysis-modal" id="analysisModal">
            <div class="analysis-header">
                <h2>📊 全班學習狀況分析</h2>
                <div>
                    <button class="class-analysis-btn" onclick="showExportModal()" style="padding: 10px 20px; font-size: 1rem; margin-right: 10px; background: linear-gradient(135deg, #28a745, #20c997);">
                        📥 匯出報告
                    </button>
                    <button class="close-analysis-btn" onclick="closeAnalysis()">✕</button>
                </div>
            </div>
            <div class="analysis-content" id="analysisContent">
                <!-- 分析內容將由 JavaScript 生成 -->
            </div>
        </div>
    </div>

    <!-- 匯出分析彈窗 -->
    <div class="export-modal-overlay" id="exportOverlay">
        <div class="export-modal">
            <h3>匯出學習分析報告</h3>
            
            <div class="export-input-group">
                <label for="schoolNameInput">園所名稱</label>
                <input type="text" id="schoolNameInput" placeholder="請輸入園所名稱">
            </div>
            
            <div class="export-input-group">
                <label for="classNameInput">班級名稱</label>
                <input type="text" id="classNameInput" placeholder="請輸入班級名稱">
            </div>
            
            <div class="export-buttons">
                <button class="export-btn export-btn-pdf" onclick="exportAsPDF()">
                    🖨️ 匯出 PDF
                </button>
                <button class="export-btn export-btn-png" onclick="exportAsImage()">
                    🖼️ 匯出圖片
                </button>
                <button class="export-btn export-btn-cancel" onclick="closeExportModal()">
                    取消
                </button>
            </div>
            
            <div class="export-loading" id="exportLoading"></div>
        </div>
    </div>


    <script>
        // 從 window 物件取得 jsPDF
        const { jsPDF } = window.jspdf;
    
        const cards = [
            { 
                name: "馬路", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-01.jpg"
            },
            { 
                name: "雨滴", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-02.jpg"
            },
            { 
                name: "小樹", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-03.jpg"
            },
            { 
                name: "風箏", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-04.jpg"
            },
            { 
                name: "池塘", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-05.jpg"
            },
            { 
                name: "蜜蜂", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-06.jpg"
            },
            { 
                name: "蝸牛", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-07.jpg"
            },
            { 
                name: "公雞", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-08.jpg"
            },
            { 
                name: "麻雀", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-09.jpg"
            },
            { 
                name: "猴子", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-10.jpg"
            },
            { 
                name: "青蛙", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-11.jpg"
            },
            { 
                name: "妹妹", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-12.jpg"
            },
            { 
                name: "弟弟", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-13.jpg"
            },
            { 
                name: "陽傘", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-15.jpg"
            },
            { 
                name: "星星", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-16.jpg"
            },
            { 
                name: "時鐘", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-17.jpg"
            },
            { 
                name: "新年", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-19.jpg"
            }
        ];

        let currentQuestion = 1;
        let gameCards = [];
        let isFlipped = false;
        let currentStudent = null;
        let completedStudents = JSON.parse(localStorage.getItem('completedStudents') || '[]');
        let studentResults = JSON.parse(localStorage.getItem('studentResults') || '{}');

        function initApp() {
            generateSeatButtons();
            updateAnalysisButton();
        }

        function generateSeatButtons() {
            const seatGrid = document.getElementById('seatGrid');
            seatGrid.innerHTML = '';
            
            for (let i = 1; i <= 30; i++) {
                const button = document.createElement('button');
                button.className = 'seat-btn';
                button.textContent = i;
                button.onclick = () => selectStudent(i);
                
                if (completedStudents.includes(i)) {
                    button.classList.add('completed');
                }
                
                seatGrid.appendChild(button);
            }
        }

        function selectStudent(seatNumber) {
            if (completedStudents.includes(seatNumber)) {
                return; // 已完成的學生不能再選擇
            }
            
            currentStudent = seatNumber;
            document.getElementById('currentSeatNumber').textContent = seatNumber;
            
            // 重置右邊顯示區域為空白狀態
            const cardDisplay = document.getElementById('cardDisplay');
            cardDisplay.classList.remove('active');
            cardDisplay.innerHTML = '<div>翻開卡片後會在這裡顯示</div>';
            cardDisplay.style.transform = 'scale(1)';
            cardDisplay.style.zIndex = '1';
            cardDisplay.style.boxShadow = '0 8px 25px rgba(139, 69, 19, 0.2)';
            
            document.getElementById('studentSelection').style.display = 'none';
            document.getElementById('gameMain').style.display = 'block';
            
            initGame();
        }

        function backToSelection() {
            document.getElementById('studentSelection').style.display = 'block';
            document.getElementById('gameMain').style.display = 'none';
            currentStudent = null;
        }

        function initGame() {
            // 顯示洗牌動畫
            showShuffleAnimation(() => {
                // 隨機選擇5張卡片
                gameCards = shuffleArray([...cards]).slice(0, 5);
                currentQuestion = 1;
                updateProgress();
                loadCurrentCard();
            });
        }

        function showShuffleAnimation(callback) {
            const container = document.querySelector('.game-container');
            const shuffleContainer = document.getElementById('shuffleCards');
            
            container.classList.add('shuffling');
            
            // 創建多張洗牌卡片
            for (let i = 0; i < 5; i++) {
                const shuffleCard = document.createElement('div');
                shuffleCard.className = 'shuffle-card';
                shuffleCard.innerHTML = '🪄';
                shuffleCard.style.zIndex = 10 - i;
                shuffleContainer.appendChild(shuffleCard);
                
                // 延遲啟動動畫
                setTimeout(() => {
                    shuffleCard.classList.add('shuffle-animation');
                }, i * 150);
            }
            
            // 動畫完成後清理
            setTimeout(() => {
                container.classList.remove('shuffling');
                shuffleContainer.innerHTML = '';
                if (callback) callback();
            }, 2000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function loadCurrentCard() {
            const card = gameCards[currentQuestion - 1];
            const cardFront = document.getElementById('cardFront');
            
            // 使用圖片
            cardFront.innerHTML = `<img src="${card.image}" alt="${card.name}" class="displayed-image" onerror="this.src=''; this.alt='圖片載入失敗'; this.style.display='none';">`;
            
            // 重置卡片狀態
            const gameCard = document.getElementById('gameCard');
            gameCard.style.transform = 'rotateY(0deg)';
            gameCard.style.transformOrigin = 'center center';
            gameCard.style.display = 'block';
            
            // 顯示卡片堆疊效果
            const cardStack = document.getElementById('cardStack');
            cardStack.style.display = 'block';
            
            // 重置老師控制區域
            const teacherControls = document.getElementById('teacherControls');
            teacherControls.style.background = '';
            teacherControls.style.color = '';
            teacherControls.style.borderRadius = '';
            teacherControls.style.padding = '';
            teacherControls.innerHTML = `
                <h3>👩‍🏫 老師判定</h3>
                <div class="control-buttons">
                    <button class="control-btn correct-btn" onclick="markAnswer(true)" title="請先翻開卡片" disabled>
                        ✓
                    </button>
                    <button class="control-btn wrong-btn" onclick="markAnswer(false)" title="請先翻開卡片" disabled>
                        ✗
                    </button>
                </div>
            `;
            
            document.getElementById('nextBtn').style.display = 'none';
            
            // 重置右邊顯示區域
            const cardDisplay = document.getElementById('cardDisplay');
            cardDisplay.classList.remove('active');
            cardDisplay.innerHTML = '<div>翻開卡片後會在這裡顯示</div>';
            cardDisplay.style.transform = 'scale(1)';
            cardDisplay.style.zIndex = '1';
            cardDisplay.style.boxShadow = '0 8px 25px rgba(139, 69, 19, 0.2)';
            
            // 確保重置翻牌狀態
            isFlipped = false;
            
            // 清理任何殘留的動畫元素
            const cardContainer = document.querySelector('.card-container');
            const existingFlipping = cardContainer.querySelectorAll('.flipping-page');
            const existingFlying = cardContainer.querySelectorAll('.flying-card');
            existingFlipping.forEach(el => el.remove());
            existingFlying.forEach(el => el.remove());
        }

        function flipCard() {
            if (!isFlipped) {
                const gameCard = document.getElementById('gameCard');
                const cardDisplay = document.getElementById('cardDisplay');
                const cardImage = document.getElementById('cardImage');
                const cardContainer = document.querySelector('.card-container');
                const cardStack = document.getElementById('cardStack');
                
                // 隱藏卡片堆疊效果
                cardStack.style.display = 'none';
                
                // 創建翻頁效果 - 以右邊為軸心翻開，初始顯示魔法棒圖案
                const flippingPage = document.createElement('div');
                flippingPage.className = 'flipping-page';
                flippingPage.innerHTML = '🪄';
                cardContainer.appendChild(flippingPage);
                
                // 在翻轉到90度時切換內容
                setTimeout(() => {
                    flippingPage.classList.add('show-content');
                    const currentCard = gameCards[currentQuestion - 1];
                    flippingPage.innerHTML = `<img src="${currentCard.image}" alt="${currentCard.name}" class="displayed-image" style="transform: scaleX(-1);" onerror="this.src=''; this.alt='圖片載入失敗'; this.style.display='none';">`;
                }, 700); // 動畫進行到一半時切換內容
                
                // 翻頁動畫完成後，創建飛行卡片移動到右邊
                setTimeout(() => {
                    // 移除翻頁元素
                    flippingPage.remove();
                    
                    // 創建飛行卡片
                    const flyingCard = document.createElement('div');
                    flyingCard.className = 'flying-card';
                    const currentCard = gameCards[currentQuestion - 1];
                    flyingCard.innerHTML = `<img src="${currentCard.image}" alt="${currentCard.name}" class="displayed-image" onerror="this.src=''; this.alt='圖片載入失敗'; this.style.display='none';">`;
                    cardContainer.appendChild(flyingCard);
                    
                    // 啟動飛行動畫
                    setTimeout(() => {
                        flyingCard.classList.add('fly-to-right');
                    }, 50);
                    
                    // 飛行動畫完成後，在右邊顯示圖片並清理飛行卡片
                    setTimeout(() => {
                        cardDisplay.classList.add('active');
                        const currentCard = gameCards[currentQuestion - 1];
                        cardDisplay.innerHTML = `<img src="${currentCard.image}" alt="${currentCard.name}" class="displayed-image" onerror="this.src=''; this.alt='圖片載入失敗'; this.style.display='none';">`;
                        flyingCard.remove();
                        
                        // 啟用老師判定按鈕
                        const correctBtn = document.querySelector('.correct-btn');
                        const wrongBtn = document.querySelector('.wrong-btn');
                        if (correctBtn && wrongBtn) {
                            correctBtn.disabled = false;
                            correctBtn.title = '答對了';
                            wrongBtn.disabled = false;
                            wrongBtn.title = '答錯了';
                        }
                    }, 1000);
                    
                }, 1400); // 等待翻頁動畫完成
                
                isFlipped = true;
            }
        }

        function markAnswer(isCorrect) {
            // 檢查卡片是否已翻開
            if (!isFlipped) {
                return;
            }
            
            // 記錄答題結果
            recordAnswer(isCorrect);
            
            if (isCorrect) {
                // 答對了，顯示彈出提示窗
                showPopup(isCorrect);
                
                // 自動進入下一題或完成遊戲
                setTimeout(() => {
                    hidePopup();
                    if (currentQuestion < 5) {
                        nextQuestion();
                    } else {
                        showCompletion();
                    }
                }, 1500);
            } else {
                // 答錯了，放大語詞卡讓孩子再看一次
                enlargeCard();
            }
        }

        function recordAnswer(isCorrect) {
            if (!currentStudent) return;
            
            const currentCard = gameCards[currentQuestion - 1];
            
            // 初始化學生記錄
            if (!studentResults[currentStudent]) {
                studentResults[currentStudent] = {
                    answers: [],
                    score: 0,
                    totalQuestions: 5,
                    correctCount: 0
                };
            }
            
            // 記錄答題結果
            studentResults[currentStudent].answers.push({
                question: currentQuestion,
                word: currentCard.name,
                correct: isCorrect,
                timestamp: new Date().toISOString()
            });
            
            // 更新分數統計 - 每題20分，只有答對才計分
            if (isCorrect) {
                studentResults[currentStudent].correctCount++;
                studentResults[currentStudent].score = studentResults[currentStudent].correctCount * 20;
            }
            
            // 記錄全班語詞統計
            let wordStats = JSON.parse(localStorage.getItem('wordStats') || '{}');
            if (!wordStats[currentCard.name]) {
                wordStats[currentCard.name] = { correct: 0, total: 0 };
            }
            
            if (isCorrect) {
                wordStats[currentCard.name].correct++;
            }
            wordStats[currentCard.name].total++;
            
            // 保存到本地儲存
            localStorage.setItem('studentResults', JSON.stringify(studentResults));
            localStorage.setItem('wordStats', JSON.stringify(wordStats));
        }

        function showPopup(isCorrect) {
            const overlay = document.getElementById('popupOverlay');
            const message = document.getElementById('popupMessage');
            const icon = document.getElementById('popupIcon');
            const text = document.getElementById('popupText');
            
            if (isCorrect) {
                message.className = 'popup-message popup-correct';
                icon.textContent = '🎉';
                text.textContent = '答對了！很棒！';
            } else {
                message.className = 'popup-message popup-wrong';
                icon.textContent = '💪';
                text.textContent = '再試一次！';
            }
            
            overlay.classList.add('show');
        }

        function hidePopup() {
            const overlay = document.getElementById('popupOverlay');
            overlay.classList.remove('show');
        }

        function enlargeCard() {
            const cardDisplay = document.getElementById('cardDisplay');
            const teacherControls = document.getElementById('teacherControls');
            
            // 放大語詞卡片
            cardDisplay.style.transform = 'scale(1.2)';
            cardDisplay.style.transition = 'transform 0.5s ease';
            cardDisplay.style.zIndex = '10';
            cardDisplay.style.boxShadow = '0 15px 40px rgba(0,0,0,0.3)';
            
            // 更新老師控制區域，顯示提示文字和繼續按鈕
            teacherControls.innerHTML = `
                <div style="text-align: center; color: #f56565; font-weight: bold; margin-bottom: 15px;">
                    📖 請孩子看著圖片再念一次
                </div>
                <button class="control-btn" onclick="continueAfterWrong()" 
                        style="background: linear-gradient(135deg, #deb887, #d2b48c); color: #8b4513; width: 120px; height: 50px; font-size: 1rem; border-radius: 25px;">
                    繼續下一題
                </button>
            `;
        }

        function continueAfterWrong() {
            const cardDisplay = document.getElementById('cardDisplay');
            
            // 恢復語詞卡片大小
            cardDisplay.style.transform = 'scale(1)';
            cardDisplay.style.zIndex = '1';
            cardDisplay.style.boxShadow = '0 8px 25px rgba(0,0,0,0.1)';
            
            // 進入下一題或完成遊戲
            if (currentQuestion < 5) {
                nextQuestion();
            } else {
                showCompletion();
            }
        }

        function nextQuestion() {
            currentQuestion++;
            updateProgress();
            loadCurrentCard();
        }

        function updateProgress() {
            const icons = document.querySelectorAll('.progress-icon');
            icons.forEach((icon, index) => {
                icon.classList.remove('completed', 'current');
                if (index < currentQuestion - 1) {
                    icon.classList.add('completed');
                } else if (index === currentQuestion - 1) {
                    icon.classList.add('current');
                }
            });
        }

        function showCompletion() {
            document.getElementById('completionMessage').style.display = 'block';
            document.querySelector('.card-container').style.display = 'none';
            document.getElementById('teacherControls').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            
            // 將所有進度圖示標記為完成
            const icons = document.querySelectorAll('.progress-icon');
            icons.forEach(icon => {
                icon.classList.remove('current');
                icon.classList.add('completed');
            });

            // 記錄學生完成狀態
            if (currentStudent && !completedStudents.includes(currentStudent)) {
                completedStudents.push(currentStudent);
                localStorage.setItem('completedStudents', JSON.stringify(completedStudents));
                
                // 更新學生完成時間
                if (studentResults[currentStudent]) {
                    studentResults[currentStudent].completedAt = new Date().toISOString();
                    localStorage.setItem('studentResults', JSON.stringify(studentResults));
                }
            }
        }

        function restartGame() {
            document.getElementById('completionMessage').style.display = 'none';
            document.querySelector('.card-container').style.display = 'block';
            document.getElementById('teacherControls').style.display = 'block';
            
            // 重置進度圖示
            const icons = document.querySelectorAll('.progress-icon');
            icons.forEach((icon, index) => {
                icon.classList.remove('completed', 'current');
                if (index === 0) {
                    icon.classList.add('current');
                }
            });
            
            // 返回學生選擇頁面
            backToSelection();
            generateSeatButtons(); // 更新座號按鈕狀態
            updateAnalysisButton();
        }

        function updateAnalysisButton() {
            const analysisBtn = document.getElementById('classAnalysisBtn');
            if (completedStudents.length > 0) {
                analysisBtn.style.display = 'inline-block';
            } else {
                analysisBtn.style.display = 'none';
            }
        }

        function showClassAnalysis() {
            const overlay = document.getElementById('analysisOverlay');
            const content = document.getElementById('analysisContent');
            
            const totalStudents = 30;
            const completedCount = completedStudents.length;
            const completionRate = Math.round((completedCount / totalStudents) * 100);
            
            // 計算全班平均分數並轉換為文字描述
            let totalScore = 0;
            completedStudents.forEach(studentNum => {
                if (studentResults[studentNum]) {
                    totalScore += studentResults[studentNum].score || 0;
                }
            });
            const averageScore = completedCount > 0 ? Math.round(totalScore / completedCount) : 0;
            
            // 將分數轉換為文字描述
            let learningStatus = '';
            let statusColor = '';
            if (averageScore >= 80) {
                learningStatus = '表現優異';
                statusColor = '#28a745';
            } else if (averageScore >= 60) {
                learningStatus = '表現良好';
                statusColor = '#007bff';
            } else {
                learningStatus = '再接再厲';
                statusColor = '#dc3545';
            }
            
            // 分析容易答錯的語詞
            const wordStats = JSON.parse(localStorage.getItem('wordStats') || '{}');
            const difficultWords = Object.entries(wordStats)
                .filter(([word, stats]) => stats.total >= 1) // 至少有1個學生答過
                .map(([word, stats]) => ({
                    word,
                    errorRate: Math.round(((stats.total - stats.correct) / stats.total) * 100),
                    correct: stats.correct,
                    total: stats.total
                }))
                .filter(item => item.errorRate >= 50) // 答錯率50%以上
                .sort((a, b) => b.errorRate - a.errorRate); // 按答錯率排序
            
            // 生成分析內容
            content.innerHTML = `
                <div class="analysis-summary">
                    <h3>📈 整體學習概況</h3>
                    <p>本次「語詞魔法師」活動已有 <strong>${completedCount}</strong> 位同學完成，全班學習狀況為 <strong style="color: ${statusColor};">${learningStatus}</strong>。</p>
                </div>
                
                <div class="analysis-stats">
                    <div class="stat-card">
                        <div class="stat-number">${completedCount}</div>
                        <div class="stat-label">已完成人數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: ${statusColor};">${learningStatus}</div>
                        <div class="stat-label">全班學習狀況</div>
                    </div>
                </div>
                
                ${difficultWords.length > 0 ? `
                <div class="student-list" style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-color: #ffc107;">
                    <h3>⚠️ 容易答錯的語詞</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; justify-content: center;">
                        ${difficultWords.map(item => `
                            <div style="background: white; padding: 15px 25px; border-radius: 20px; border: 2px solid #ffc107; text-align: center;">
                                <div style="font-size: 1.4rem; font-weight: bold; color: #856404;">${item.word}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 15px; border: 2px solid #2196f3;">
                    <h3 style="color: #1565c0; margin-bottom: 15px;">💡 學習建議</h3>
                    <ul style="color: #1565c0; text-align: left; margin: 0; padding-left: 20px;">
                        <li>建議繼續鼓勵尚未完成的同學參與活動</li>
                        <li>可以安排已完成的同學協助其他同學</li>
                        ${difficultWords.length > 0 ? `<li style="color: #dc3545; font-weight: bold;">特別加強練習：${difficultWords.slice(0, 3).map(item => item.word).join('、')} 等語詞</li>` : ''}
                        <li>注音符號學習需要反覆練習，建議定期複習</li>
                        <li>可以結合其他教學活動強化學習效果</li>
                        ${averageScore >= 80 ? '<li style="color: #2e7d32; font-weight: bold;">🎉 全班表現優秀！可以進行下一階段的學習活動</li>' : ''}
                        ${averageScore < 60 ? '<li style="color: #dc3545; font-weight: bold;">📚 建議加強基礎練習，可安排個別輔導</li>' : ''}
                    </ul>
                </div>
            `;
            
            overlay.classList.add('show');
        }

        function closeAnalysis() {
            document.getElementById('analysisOverlay').classList.remove('show');
        }

        function resetClassProgress() {
            // 創建自定義確認對話框
            const confirmOverlay = document.createElement('div');
            confirmOverlay.className = 'popup-overlay';
            confirmOverlay.style.display = 'flex';
            confirmOverlay.innerHTML = `
                <div class="popup-message" style="max-width: 500px;">
                    <div class="popup-icon" style="font-size: 3rem; color: #dc3545; margin-bottom: 20px;">⚠️</div>
                    <div class="popup-text" style="font-size: 1.3rem; margin-bottom: 20px;">
                        確定要重製全班進度嗎？<br>
                        這將清除所有學習記錄，讓下一班可以重新開始遊戲。<br>
                        <strong style="color: #dc3545;">此操作無法復原。</strong>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="confirmReset()" style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer;">
                            確定重製
                        </button>
                        <button onclick="cancelReset()" style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer;">
                            取消
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmOverlay);
            
            // 顯示對話框
            setTimeout(() => {
                confirmOverlay.classList.add('show');
            }, 10);
            
            // 確認重製函數
            window.confirmReset = function() {
                localStorage.removeItem('completedStudents');
                localStorage.removeItem('studentResults');
                localStorage.removeItem('wordStats');
                completedStudents = [];
                studentResults = {};
                generateSeatButtons();
                updateAnalysisButton();
                
                // 移除確認對話框
                confirmOverlay.remove();
                delete window.confirmReset;
                delete window.cancelReset;
                
                // 顯示成功訊息
                showSuccessMessage();
            };
            
            // 取消函數
            window.cancelReset = function() {
                confirmOverlay.remove();
                delete window.confirmReset;
                delete window.cancelReset;
            };
        }
        
        function showSuccessMessage() {
            const successOverlay = document.createElement('div');
            successOverlay.className = 'popup-overlay';
            successOverlay.style.display = 'flex';
            successOverlay.innerHTML = `
                <div class="popup-message popup-correct">
                    <div class="popup-icon">✅</div>
                    <div class="popup-text">全班進度已重製完成！<br>下一班可以開始遊戲了。</div>
                </div>
            `;
            document.body.appendChild(successOverlay);
            
            // 顯示成功訊息
            setTimeout(() => {
                successOverlay.classList.add('show');
            }, 10);
            
            // 3秒後自動關閉
            setTimeout(() => {
                successOverlay.classList.remove('show');
                setTimeout(() => {
                    successOverlay.remove();
                }, 300);
            }, 3000);
        }

        function clearAllData() {
            if (confirm('確定要清除所有學習記錄嗎？此操作無法復原。')) {
                localStorage.removeItem('completedStudents');
                localStorage.removeItem('studentResults');
                localStorage.removeItem('wordStats');
                completedStudents = [];
                studentResults = {};
                generateSeatButtons();
                updateAnalysisButton();
                closeAnalysis();
            }
        }

        // --- 新增匯出功能 ---

        function showExportModal() {
            // 預先填入上次輸入的資料
            document.getElementById('schoolNameInput').value = localStorage.getItem('exportSchoolName') || '';
            document.getElementById('classNameInput').value = localStorage.getItem('exportClassName') || '';
            
            document.getElementById('exportOverlay').classList.add('show');
            document.getElementById('exportLoading').style.display = 'none';
            
            // 暫時隱藏分析彈窗，避免重疊
            document.getElementById('analysisModal').style.visibility = 'hidden';
        }

        function closeExportModal() {
            document.getElementById('exportOverlay').classList.remove('show');
            // 重新顯示分析彈窗
            document.getElementById('analysisModal').style.visibility = 'visible';
        }

        // 準備要匯出的 HTML 內容
        async function prepareExportContent(schoolName, className) {
            // 1. 取得原始分析內容
            const analysisContent = document.getElementById('analysisContent').innerHTML;
            
            // 2. 建立暫存的 container
            const exportContainer = document.createElement('div');
            exportContainer.className = 'export-preview-container';
            
            // 3. 加入新的標頭（園所、班級名稱）
            let headerHtml = `
                <h2>${schoolName || '語詞魔法師'}</h2>
                <h3>${className || ''} 學習分析報告</h3>
            `;
            
            // 4. 組合標頭和分析內容
            exportContainer.innerHTML = headerHtml + analysisContent;
            
            // 5. 將它附加到 body (畫面外)，html2canvas 才能擷取
            document.body.appendChild(exportContainer);
            
            // 等待瀏覽器渲染
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // 6. 使用 html2canvas 擷取
            const canvas = await html2canvas(exportContainer, {
                scale: 2, // 提高解析度
                useCORS: true,
                logging: false,
                onclone: (doc) => {
                    // 確保複製的 DOM 是可見的
                    const container = doc.querySelector('.export-preview-container');
                    container.style.position = 'static';
                    container.style.left = '0';
                    container.style.top = '0';
                }
            });
            
            // 7. 清理暫存的 container
            document.body.removeChild(exportContainer);
            
            // 8. 回傳 canvas 物件
            return canvas;
        }

        async function exportAsPDF() {
            const loadingSpinner = document.getElementById('exportLoading');
            loadingSpinner.style.display = 'block';

            const schoolName = document.getElementById('schoolNameInput').value;
            const className = document.getElementById('classNameInput').value;
            
            // 儲存輸入值，方便下次使用
            localStorage.setItem('exportSchoolName', schoolName);
            localStorage.setItem('exportClassName', className);
            
            try {
                const canvas = await prepareExportContent(schoolName, className);
                const imgData = canvas.toDataURL('image/png');
                
                const pdf = new jsPDF({
                    orientation: 'p', // 縱向
                    unit: 'px', // 單位
                    format: 'a4' // 格式
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // 計算圖片長寬比
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgWidth / imgHeight;
                
                let finalImgWidth = pdfWidth - 20; // A4 寬度減去邊界
                let finalImgHeight = finalImgWidth / ratio;

                // 檢查高度是否超出
                if (finalImgHeight > pdfHeight - 20) {
                    finalImgHeight = pdfHeight - 20; // A4 高度減去邊界
                    finalImgWidth = finalImgHeight * ratio;
                }
                
                // 置中圖片
                const x = (pdfWidth - finalImgWidth) / 2;
                const y = 10; // 頂部邊界

                pdf.addImage(imgData, 'PNG', x, y, finalImgWidth, finalImgHeight);
                
                const fileName = `${schoolName || '學習分析'}_${className || '報告'}.pdf`;
                pdf.save(fileName);
                
            } catch (error) {
                console.error('匯出 PDF 失敗:', error);
                // 在真實應用中，應使用自訂彈窗
                alert('匯出 PDF 時發生錯誤，請稍後再試。'); 
            } finally {
                loadingSpinner.style.display = 'none';
                closeExportModal();
            }
        }

        async function exportAsImage() {
            const loadingSpinner = document.getElementById('exportLoading');
            loadingSpinner.style.display = 'block';

            const schoolName = document.getElementById('schoolNameInput').value;
            const className = document.getElementById('classNameInput').value;
            
            // 儲存輸入值
            localStorage.setItem('exportSchoolName', schoolName);
            localStorage.setItem('exportClassName', className);
            
            try {
                const canvas = await prepareExportContent(schoolName, className);
                const imgData = canvas.toDataURL('image/png');
                
                const link = document.createElement('a');
                const fileName = `${schoolName || '學習分析'}_${className || '報告'}.png`;
                link.download = fileName;
                link.href = imgData;
                
                document.body.appendChild(link); // 為了 Firefox 瀏覽器
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error('匯出圖片失敗:', error);
                // 在真實應用中，應使用自訂彈窗
                alert('匯出圖片時發生錯誤，請稍後再試。');
            } finally {
                loadingSpinner.style.display = 'none';
                closeExportModal();
            }
        }
        
        // --- 匯出功能結束 ---
        
        // --- 全螢幕功能 ---
        function toggleFullScreen() {
            const fsBtn = document.getElementById('fullscreenBtn');
            const enterIcon = document.getElementById('fs-enter-icon');
            const exitIcon = document.getElementById('fs-exit-icon');

            if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                // 進入全螢幕
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) { // Firefox
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari and Opera
                    document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
                    document.documentElement.msRequestFullscreen();
                }
            } else {
                // 結束全螢幕
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
            }
        }
        
        // 監聽全螢幕狀態變化 (例如: 按下 ESC 鍵)
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('MSFullscreenChange', updateFullscreenButton);

        function updateFullscreenButton() {
            const fsBtn = document.getElementById('fullscreenBtn');
            const enterIcon = document.getElementById('fs-enter-icon');
            const exitIcon = document.getElementById('fs-exit-icon');
            
            if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                // 目前非全螢幕
                fsBtn.title = "全螢幕";
                enterIcon.style.display = 'block';
                exitIcon.style.display = 'none';
            } else {
                // 目前為全螢幕
                fsBtn.title = "結束全螢幕";
                enterIcon.style.display = 'none';
                exitIcon.style.display = 'block';
            }
        }
        // --- 全螢幕功能結束 ---


        // 初始化應用程式
        initApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992f2988735bf21c',t:'MTc2MTIwMDc3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

