<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªè©é­”æ³•å¸«</title>
    <!-- åŒ¯å‡º PDF å’Œåœ–ç‰‡æ‰€éœ€å¥—ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #faf8f3 0%, #f5f1e8 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-container {
            background: #fefcf8;
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.15);
            text-align: center;
            max-width: 1000px;
            width: 100%;
            border: 2px solid #e6d7c3;
            position: relative; /* ç‚ºäº†å…¨è¢å¹•æŒ‰éˆ•å®šä½ */
        }
        
        .fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #fefcf8;
            border: 2px solid #e6d7c3;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #8b4513;
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .fullscreen-btn:hover {
            background: #f5f1e8;
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.1);
            transform: scale(1.05);
        }
        
        .fullscreen-btn svg {
            width: 24px;
            height: 24px;
            stroke: #8b4513;
        }

        .game-layout {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            justify-content: center;
            margin-top: 30px;
        }

        .left-section {
            flex: 1;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .right-section {
            flex: 1;
            max-width: 400px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .card-display {
            width: 280px;
            height: 400px;
            border: 5px dashed #deb887;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f6f0;
            color: #8b6914;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 30px;
        }

        .card-display.active {
            border: 5px solid #deb887;
            background: #fefcf8;
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.2);
        }

        .displayed-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }

        .game-title {
            color: #8b4513;
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 25px;
            text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.1);
            letter-spacing: 1px;
        }

        .progress-icons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .progress-icon {
            font-size: 2.5rem;
            transition: all 0.3s ease;
            color: #d2b48c;
            filter: grayscale(100%);
        }

        .progress-icon.completed {
            color: #daa520;
            filter: none;
        }

        .progress-icon.current {
            color: #b8860b;
            filter: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .question-counter {
            font-size: 1.5rem;
            color: #4a5568;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .card-container {
            perspective: 1000px;
            width: 280px;
            height: 400px;
            position: relative;
            z-index: 50;
            margin-top: 30px;
        }

        .card-stack {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .stack-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f5dc 0%, #deb887 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #374151;
            font-size: 3rem;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: 2px solid #d4af37;
        }

        .stack-card:nth-child(1) {
            transform: translate(-8px, -8px) rotate(-2deg);
            z-index: 1;
            opacity: 0.7;
        }

        .stack-card:nth-child(2) {
            transform: translate(-4px, -4px) rotate(-1deg);
            z-index: 2;
            opacity: 0.85;
        }

        .stack-card:nth-child(3) {
            transform: translate(0px, 0px) rotate(0deg);
            z-index: 3;
            opacity: 1;
        }

        .shuffle-cards {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .shuffle-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f5dc 0%, #deb887 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #374151;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            opacity: 0;
        }

        .shuffle-animation {
            animation: shuffleCard 0.8s ease-in-out forwards;
        }

        @keyframes shuffleCard {
            0% {
                opacity: 1;
                transform: translateX(0) translateY(0) rotate(0deg) scale(1);
            }
            25% {
                opacity: 1;
                transform: translateX(-100px) translateY(-50px) rotate(-15deg) scale(0.9);
            }
            50% {
                opacity: 1;
                transform: translateX(100px) translateY(-30px) rotate(15deg) scale(0.9);
            }
            75% {
                opacity: 1;
                transform: translateX(-50px) translateY(20px) rotate(-8deg) scale(0.95);
            }
            100% {
                opacity: 0;
                transform: translateX(0) translateY(0) rotate(0deg) scale(1);
            }
        }

        .game-container.shuffling .card {
            opacity: 0;
        }

        .game-container.shuffling .question-counter,
        .game-container.shuffling .teacher-controls {
            opacity: 0.3;
        }

        .card {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            transform-style: preserve-3d;
            cursor: pointer;
            z-index: 100;
        }

        .flipping-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 300;
            transform-origin: center center;
            animation: naturalFlip 1.4s ease-in-out forwards;
            background: linear-gradient(135deg, #f5f5dc 0%, #deb887 100%);
            color: #374151;
            font-size: 3rem;
            font-weight: bold;
        }

        .flipping-page.show-content {
            background: white;
            border: 3px solid #e2e8f0;
            color: initial;
            font-size: initial;
            font-weight: initial;
        }

        @keyframes naturalFlip {
            0% {
                transform: rotateY(0deg) rotateX(0deg) scale(1);
                opacity: 1;
            }
            20% {
                transform: rotateY(20deg) rotateX(-5deg) scale(1.02);
                opacity: 1;
            }
            50% {
                transform: rotateY(90deg) rotateX(-10deg) scale(1.05);
                opacity: 1;
            }
            80% {
                transform: rotateY(160deg) rotateX(-5deg) scale(1.02);
                opacity: 1;
            }
            100% {
                transform: rotateY(180deg) rotateX(0deg) scale(1);
                opacity: 0;
            }
        }

        .flying-card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 100;
            pointer-events: none;
            opacity: 0;
        }



        .fly-to-right {
            animation: flyToRight 1s ease-in-out forwards;
        }

        @keyframes flyToRight {
            0% {
                opacity: 1;
                transform: translateX(0) translateY(0) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateX(200px) translateY(-20px) scale(0.8);
            }
            100% {
                opacity: 0;
                transform: translateX(400px) translateY(0) scale(1);
            }
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-back {
            background: linear-gradient(135deg, #f5f5dc 0%, #deb887 100%);
            color: #374151;
            font-size: 3rem;
            font-weight: bold;
        }

        .card-front {
            background: white;
            transform: rotateY(180deg);
            border: 3px solid #e2e8f0;
            flex-direction: column;
            padding: 20px;
        }

        .card-text {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2d3748;
        }

        .teacher-controls {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .teacher-controls.show {
            display: flex;
        }

        .teacher-controls h3 {
            margin: 0 !important;
            color: #8b4513;
            font-size: 1.2rem;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 12px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .control-btn:disabled:hover {
            transform: none !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .correct-btn {
            background: white;
            color: #16a34a;
            border: 3px solid #16a34a;
        }

        .correct-btn:hover {
            transform: scale(1.05);
            background: #f0fdf4;
            box-shadow: 0 6px 20px rgba(22, 163, 74, 0.2);
        }

        .wrong-btn {
            background: white;
            color: #dc2626;
            border: 3px solid #dc2626;
        }

        .wrong-btn:hover {
            transform: scale(1.05);
            background: #fef2f2;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.2);
        }

        .next-btn {
            background: linear-gradient(135deg, #deb887, #d2b48c);
            color: #8b4513;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            display: none;
        }

        .next-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(222, 184, 135, 0.4);
        }

        .completion-message {
            background: linear-gradient(135deg, #f4e4bc, #e6d7c3);
            color: #8b4513;
            padding: 30px;
            border-radius: 20px;
            margin-top: 30px;
            font-size: 1.5rem;
            font-weight: 600;
            display: none;
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.2);
            border: 2px solid #deb887;
        }

        .restart-btn {
            background: linear-gradient(135deg, #daa520, #b8860b);
            color: #fefcf8;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(218, 165, 32, 0.4);
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup-message {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: all 0.3s ease;
            max-width: 400px;
            width: 90%;
        }

        .popup-overlay.show .popup-message {
            transform: scale(1);
        }

        .popup-correct {
            border: 4px solid #48bb78;
        }

        .popup-correct .popup-icon {
            font-size: 4rem;
            color: #48bb78;
            margin-bottom: 20px;
        }

        .popup-correct .popup-text {
            font-size: 1.8rem;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 10px;
        }

        .popup-wrong {
            border: 4px solid #f56565;
        }

        .popup-wrong .popup-icon {
            font-size: 4rem;
            color: #f56565;
            margin-bottom: 20px;
        }

        .popup-wrong .popup-text {
            font-size: 1.8rem;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 10px;
        }

        .student-selection {
            text-align: center;
            padding: 20px;
        }

        .selection-title {
            color: #8b4513;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .seat-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 0 auto 30px auto;
        }

        .seat-btn {
            width: 80px;
            height: 60px;
            border: 3px solid #deb887;
            border-radius: 12px;
            background: linear-gradient(135deg, #fefcf8, #f9f6f0);
            color: #8b4513;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .seat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(222, 184, 135, 0.4);
            background: linear-gradient(135deg, #f9f6f0, #f4e4bc);
        }

        .seat-btn.completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
            color: #155724;
        }

        .seat-btn.completed::after {
            content: ' âœ“';
            color: #28a745;
        }

        .seat-btn.completed:hover {
            transform: none;
            cursor: not-allowed;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .class-controls {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .class-analysis-btn {
            background: linear-gradient(135deg, #6f42c1, #5a32a3);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 200px;
        }

        .class-analysis-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.4);
        }

        .class-reset-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 200px;
        }

        .class-reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }

        .current-student {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #e8f4f8, #d1ecf1);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #bee5eb;
        }

        .student-info {
            color: #0c5460;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .back-to-selection-btn {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-to-selection-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .analysis-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .analysis-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .analysis-modal {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: all 0.3s ease;
        }

        .analysis-overlay.show .analysis-modal {
            transform: scale(1);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 2px solid #e9ecef;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 20px 20px 0 0;
            gap: 15px; /* æ–°å¢ */
        }

        .analysis-header h2 {
            margin: 0;
            color: #495057;
            font-size: 1.8rem;
            flex-grow: 1; /* æ–°å¢ */
            text-align: left; /* æ–°å¢ */
        }
        
        .analysis-header div { /* æ–°å¢ */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-analysis-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-analysis-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .analysis-content {
            padding: 30px;
        }

        .analysis-summary {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #28a745;
        }

        .analysis-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #dee2e6;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 1rem;
        }

        .student-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #dee2e6;
        }

        .student-list h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .completed-students {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .student-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        /* --- æ–°å¢åŒ¯å‡ºå½ˆçª—æ¨£å¼ --- */
        .export-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* è¼ƒæš—çš„èƒŒæ™¯ */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000; /* ç¢ºä¿åœ¨åˆ†æå½ˆçª—ä¹‹ä¸Š */
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .export-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .export-modal {
            background: white;
            padding: 30px 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: all 0.3s ease;
            max-width: 450px;
            width: 90%;
        }

        .export-modal-overlay.show .export-modal {
            transform: scale(1);
        }
        
        .export-modal h3 {
            color: #8b4513;
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 25px;
        }
        
        .export-input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .export-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }
        
        .export-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #deb887;
            border-radius: 12px;
            font-size: 1.1rem;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒç ´å£æ’ç‰ˆ */
        }
        
        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        
        .export-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .export-btn-pdf {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        .export-btn-pdf:hover {
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }
        
        .export-btn-png {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        .export-btn-png:hover {
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }
        
        .export-btn-cancel {
            background: #6c757d;
            color: white;
            margin-top: 10px;
        }
        .export-btn-cancel:hover {
            background: #5a6268;
        }
        
        /* åŒ¯å‡ºæ™‚çš„è®€å–åœ–ç¤º */
        .export-loading {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8b4513;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto 0 auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ç”¨æ–¼ç”¢ç”Ÿ PDF/åœ–ç‰‡ çš„æš«å­˜æ¨£å¼ */
        .export-preview-container {
            position: absolute;
            left: -9999px; /* ç§»å‡ºç•«é¢å¤– */
            top: 0;
            width: 800px; /* å›ºå®šå¯¬åº¦ä»¥çµ±ä¸€ PDF è¼¸å‡º */
            background: #ffffff;
            padding: 40px;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            box-sizing: border-box;
        }
        .export-preview-container h2 {
            text-align: center;
            color: #8b4513;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .export-preview-container h3 {
             text-align: center;
            color: #4a5568;
            font-size: 1.5rem;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }
        /* ç‚º PDF é‡æ–°è¨­å®šåˆ†æå…§å®¹çš„æ¨£å¼ */
        .export-preview-container .analysis-summary {
            background: #d4edda !important;
            border: 1px solid #28a745;
            color: #155724;
        }
        .export-preview-container .analysis-stats {
            grid-template-columns: repeat(2, 1fr); /* å¼·åˆ¶å…©æ¬„ */
        }
        .export-preview-container .stat-card {
            background: #f8f9fa !important;
            border: 1px solid #dee2e6;
        }
        .export-preview-container .student-list {
            background: #fff3cd !important;
            border: 1px solid #ffc107;
        }
        .export-preview-container [style*="background: linear-gradient"] {
            background: none !important; /* ç§»é™¤æ¼¸å±¤ */
        }
        .export-preview-container [style*="#e3f2fd"] { /* å­¸ç¿’å»ºè­° */
            background: #e3f2fd !important;
            border: 1px solid #2196f3;
        }
        .export-preview-container ul {
            text-align: left;
            padding-left: 25px;
        }
        /* --- æ¨£å¼çµæŸ --- */


        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .game-layout {
                flex-direction: column;
                gap: 20px;
            }
            
            .left-section, .right-section {
                max-width: 100%;
            }
            
            .card-container {
                width: 210px;
                height: 300px;
            }
            
            .card-display {
                width: 210px;
                height: 300px;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }

            .seat-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
            }

            .seat-btn {
                width: 60px;
                height: 50px;
                font-size: 1rem;
            }

            .current-student {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .analysis-modal {
                width: 95%;
                max-height: 90vh;
            }

            .analysis-header {
                padding: 20px;
                flex-direction: column; /* çª„è¢å¹•æ™‚æŒ‰éˆ•æ›è¡Œ */
                align-items: flex-start;
            }
            
            .fullscreen-btn {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
            
            .fullscreen-btn svg {
                width: 20px;
                height: 20px;
            }

            .analysis-content {
                padding: 20px;
            }

            .analysis-stats {
                grid-template-columns: 1fr;
            }

            .class-controls {
                flex-direction: column;
                gap: 15px;
            }

            .class-analysis-btn,
            .class-reset-btn {
                max-width: 100%;
            }
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <div class="game-container">
        <button id="fullscreenBtn" class="fullscreen-btn" onclick="toggleFullScreen()" title="å…¨è¢å¹•">
            <svg id="fs-enter-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
            <svg id="fs-exit-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><path d="M5 16H3v3a2 2 0 0 0 2 2h3v-2H5zM5 8H3V5a2 2 0 0 1 2-2h3v2H5zM19 8h2V5a2 2 0 0 0-2-2h-3v2h3zM19 16h2v3a2 2 0 0 1-2 2h-3v-2h3z"></path></svg>
        </button>
        
        <h1 class="game-title">ğŸª„ èªè©é­”æ³•å¸«</h1>
        
        <!-- å­¸ç”Ÿåº§è™Ÿé¸æ“‡å€åŸŸ -->
        <div class="student-selection" id="studentSelection">
            <h2 class="selection-title">ğŸ‘¨â€ğŸ“ è«‹é¸æ“‡å­¸ç”Ÿåº§è™Ÿ</h2>
            <div class="seat-grid" id="seatGrid">
                <!-- åº§è™ŸæŒ‰éˆ•å°‡ç”± JavaScript ç”Ÿæˆ -->
            </div>
            <div class="class-controls">
                <button class="class-analysis-btn" id="classAnalysisBtn" onclick="showClassAnalysis()">
                    ğŸ“Š å…¨ç­å­¸ç¿’åˆ†æ
                </button>
                <button class="class-reset-btn" onclick="resetClassProgress()">
                    ğŸ”„ é‡è£½å…¨ç­é€²åº¦
                </button>
            </div>
        </div>
        
        <!-- éŠæˆ²ä¸»è¦å€åŸŸ -->
        <div class="game-main" id="gameMain" style="display: none;">
            <div class="current-student" id="currentStudent">
                <span class="student-info">ğŸ‘¨â€ğŸ“ åº§è™Ÿ <span id="currentSeatNumber">1</span> è™ŸåŒå­¸</span>
                <button class="back-to-selection-btn" onclick="backToSelection()">â† è¿”å›é¸æ“‡</button>
            </div>
        
        <div class="game-layout">
            <div class="left-section">
                <div class="progress-icons" id="progressIcons">
                    <div class="progress-icon current">â­</div>
                    <div class="progress-icon">â­</div>
                    <div class="progress-icon">â­</div>
                    <div class="progress-icon">â­</div>
                    <div class="progress-icon">â­</div>
                </div>
                <div class="card-container">
                    <div class="card-stack" id="cardStack">
                        <div class="stack-card">ğŸª„</div>
                        <div class="stack-card">ğŸª„</div>
                        <div class="stack-card">ğŸª„</div>
                    </div>
                    <div class="shuffle-cards" id="shuffleCards"></div>
                    <div class="card" id="gameCard" onclick="flipCard()">
                        <div class="card-face card-back">
                            <div>ğŸª„</div>
                        </div>
                        <div class="card-face card-front" id="cardFront">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="right-section">
                <div class="teacher-controls" id="teacherControls">
                    <h3>ğŸ‘©â€ğŸ« è€å¸«åˆ¤å®š</h3>
                    <div class="control-buttons">
                        <button class="control-btn correct-btn" onclick="markAnswer(true)" title="ç­”å°äº†">
                            âœ“
                        </button>
                        <button class="control-btn wrong-btn" onclick="markAnswer(false)" title="ç­”éŒ¯äº†">
                            âœ—
                        </button>
                    </div>
                </div>
                <div class="card-display" id="cardDisplay">
                    <div>ç¿»é–‹å¡ç‰‡å¾Œæœƒåœ¨é€™è£¡é¡¯ç¤º</div>
                </div>
            </div>
        </div>
        

        
        <button class="next-btn" id="nextBtn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â†’</button>
        
        <div class="completion-message" id="completionMessage">
            ğŸ‰ æ­å–œå®Œæˆï¼ä½ å·²ç¶“å­¸æœƒäº† 5 å€‹æ³¨éŸ³è©å½™ï¼
            <br>
            <button class="restart-btn" onclick="restartGame()">è¿”å›åº§è™Ÿé¸æ“‡</button>
        </div>
        </div> <!-- é—œé–‰ game-main -->
    </div>

    <!-- å½ˆå‡ºæç¤ºçª— -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-message" id="popupMessage">
            <div class="popup-icon" id="popupIcon"></div>
            <div class="popup-text" id="popupText"></div>
        </div>
    </div>

    <!-- å…¨ç­åˆ†æå½ˆçª— -->
    <div class="analysis-overlay" id="analysisOverlay">
        <div class="analysis-modal" id="analysisModal">
            <div class="analysis-header">
                <h2>ğŸ“Š å…¨ç­å­¸ç¿’ç‹€æ³åˆ†æ</h2>
                <div>
                    <button class="class-analysis-btn" onclick="showExportModal()" style="padding: 10px 20px; font-size: 1rem; margin-right: 10px; background: linear-gradient(135deg, #28a745, #20c997);">
                        ğŸ“¥ åŒ¯å‡ºå ±å‘Š
                    </button>
                    <button class="close-analysis-btn" onclick="closeAnalysis()">âœ•</button>
                </div>
            </div>
            <div class="analysis-content" id="analysisContent">
                <!-- åˆ†æå…§å®¹å°‡ç”± JavaScript ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- åŒ¯å‡ºåˆ†æå½ˆçª— -->
    <div class="export-modal-overlay" id="exportOverlay">
        <div class="export-modal">
            <h3>åŒ¯å‡ºå­¸ç¿’åˆ†æå ±å‘Š</h3>
            
            <div class="export-input-group">
                <label for="schoolNameInput">åœ’æ‰€åç¨±</label>
                <input type="text" id="schoolNameInput" placeholder="è«‹è¼¸å…¥åœ’æ‰€åç¨±">
            </div>
            
            <div class="export-input-group">
                <label for="classNameInput">ç­ç´šåç¨±</label>
                <input type="text" id="classNameInput" placeholder="è«‹è¼¸å…¥ç­ç´šåç¨±">
            </div>
            
            <div class="export-buttons">
                <button class="export-btn export-btn-pdf" onclick="exportAsPDF()">
                    ğŸ–¨ï¸ åŒ¯å‡º PDF
                </button>
                <button class="export-btn export-btn-png" onclick="exportAsImage()">
                    ğŸ–¼ï¸ åŒ¯å‡ºåœ–ç‰‡
                </button>
                <button class="export-btn export-btn-cancel" onclick="closeExportModal()">
                    å–æ¶ˆ
                </button>
            </div>
            
            <div class="export-loading" id="exportLoading"></div>
        </div>
    </div>


    <script>
        // å¾ window ç‰©ä»¶å–å¾— jsPDF
        const { jsPDF } = window.jspdf;
    
        const cards = [
            { 
                name: "é¦¬è·¯", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-01.jpg"
            },
            { 
                name: "é›¨æ»´", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-02.jpg"
            },
            { 
                name: "å°æ¨¹", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-03.jpg"
            },
            { 
                name: "é¢¨ç®", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-04.jpg"
            },
            { 
                name: "æ± å¡˜", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-05.jpg"
            },
            { 
                name: "èœœèœ‚", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-06.jpg"
            },
            { 
                name: "è¸ç‰›", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-07.jpg"
            },
            { 
                name: "å…¬é›", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-08.jpg"
            },
            { 
                name: "éº»é›€", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-09.jpg"
            },
            { 
                name: "çŒ´å­", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-10.jpg"
            },
            { 
                name: "é’è›™", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-11.jpg"
            },
            { 
                name: "å¦¹å¦¹", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-12.jpg"
            },
            { 
                name: "å¼Ÿå¼Ÿ", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-13.jpg"
            },
            { 
                name: "é™½å‚˜", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-15.jpg"
            },
            { 
                name: "æ˜Ÿæ˜Ÿ", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-16.jpg"
            },
            { 
                name: "æ™‚é˜", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-17.jpg"
            },
            { 
                name: "æ–°å¹´", 
                image: "https://raw.githubusercontent.com/genikid-ai/Curated/refs/heads/main/Senior-01/20250820-19.jpg"
            }
        ];

        let currentQuestion = 1;
        let gameCards = [];
        let isFlipped = false;
        let currentStudent = null;
        let completedStudents = JSON.parse(localStorage.getItem('completedStudents') || '[]');
        let studentResults = JSON.parse(localStorage.getItem('studentResults') || '{}');

        function initApp() {
            generateSeatButtons();
            updateAnalysisButton();
        }

        function generateSeatButtons() {
            const seatGrid = document.getElementById('seatGrid');
            seatGrid.innerHTML = '';
            
            for (let i = 1; i <= 30; i++) {
                const button = document.createElement('button');
                button.className = 'seat-btn';
                button.textContent = i;
                button.onclick = () => selectStudent(i);
                
                if (completedStudents.includes(i)) {
                    button.classList.add('completed');
                }
                
                seatGrid.appendChild(button);
            }
        }

        function selectStudent(seatNumber) {
            if (completedStudents.includes(seatNumber)) {
                return; // å·²å®Œæˆçš„å­¸ç”Ÿä¸èƒ½å†é¸æ“‡
            }
            
            currentStudent = seatNumber;
            document.getElementById('currentSeatNumber').textContent = seatNumber;
            
            // é‡ç½®å³é‚Šé¡¯ç¤ºå€åŸŸç‚ºç©ºç™½ç‹€æ…‹
            const cardDisplay = document.getElementById('cardDisplay');
            cardDisplay.classList.remove('active');
            cardDisplay.innerHTML = '<div>ç¿»é–‹å¡ç‰‡å¾Œæœƒåœ¨é€™è£¡é¡¯ç¤º</div>';
            cardDisplay.style.transform = 'scale(1)';
            cardDisplay.style.zIndex = '1';
            cardDisplay.style.boxShadow = '0 8px 25px rgba(139, 69, 19, 0.2)';
            
            document.getElementById('studentSelection').style.display = 'none';
            document.getElementById('gameMain').style.display = 'block';
            
            initGame();
        }

        function backToSelection() {
            document.getElementById('studentSelection').style.display = 'block';
            document.getElementById('gameMain').style.display = 'none';
            currentStudent = null;
        }

        function initGame() {
            // é¡¯ç¤ºæ´—ç‰Œå‹•ç•«
            showShuffleAnimation(() => {
                // éš¨æ©Ÿé¸æ“‡5å¼µå¡ç‰‡
                gameCards = shuffleArray([...cards]).slice(0, 5);
                currentQuestion = 1;
                updateProgress();
                loadCurrentCard();
            });
        }

        function showShuffleAnimation(callback) {
            const container = document.querySelector('.game-container');
            const shuffleContainer = document.getElementById('shuffleCards');
            
            container.classList.add('shuffling');
            
            // å‰µå»ºå¤šå¼µæ´—ç‰Œå¡ç‰‡
            for (let i = 0; i < 5; i++) {
                const shuffleCard = document.createElement('div');
                shuffleCard.className = 'shuffle-card';
                shuffleCard.innerHTML = 'ğŸª„';
                shuffleCard.style.zIndex = 10 - i;
                shuffleContainer.appendChild(shuffleCard);
                
                // å»¶é²å•Ÿå‹•å‹•ç•«
                setTimeout(() => {
                    shuffleCard.classList.add('shuffle-animation');
                }, i * 150);
            }
            
            // å‹•ç•«å®Œæˆå¾Œæ¸…ç†
            setTimeout(() => {
                container.classList.remove('shuffling');
                shuffleContainer.innerHTML = '';
                if (callback) callback();
            }, 2000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function loadCurrentCard() {
            const card = gameCards[currentQuestion - 1];
            const cardFront = document.getElementById('cardFront');
            
            // ä½¿ç”¨åœ–ç‰‡
            cardFront.innerHTML = `<img src="${card.image}" alt="${card.name}" class="displayed-image" onerror="this.src=''; this.alt='åœ–ç‰‡è¼‰å…¥å¤±æ•—'; this.style.display='none';">`;
            
            // é‡ç½®å¡ç‰‡ç‹€æ…‹
            const gameCard = document.getElementById('gameCard');
            gameCard.style.transform = 'rotateY(0deg)';
            gameCard.style.transformOrigin = 'center center';
            gameCard.style.display = 'block';
            
            // é¡¯ç¤ºå¡ç‰‡å †ç–Šæ•ˆæœ
            const cardStack = document.getElementById('cardStack');
            cardStack.style.display = 'block';
            
            // é‡ç½®è€å¸«æ§åˆ¶å€åŸŸ
            const teacherControls = document.getElementById('teacherControls');
            teacherControls.style.background = '';
            teacherControls.style.color = '';
            teacherControls.style.borderRadius = '';
            teacherControls.style.padding = '';
            teacherControls.innerHTML = `
                <h3>ğŸ‘©â€ğŸ« è€å¸«åˆ¤å®š</h3>
                <div class="control-buttons">
                    <button class="control-btn correct-btn" onclick="markAnswer(true)" title="è«‹å…ˆç¿»é–‹å¡ç‰‡" disabled>
                        âœ“
                    </button>
                    <button class="control-btn wrong-btn" onclick="markAnswer(false)" title="è«‹å…ˆç¿»é–‹å¡ç‰‡" disabled>
                        âœ—
                    </button>
                </div>
            `;
            
            document.getElementById('nextBtn').style.display = 'none';
            
            // é‡ç½®å³é‚Šé¡¯ç¤ºå€åŸŸ
            const cardDisplay = document.getElementById('cardDisplay');
            cardDisplay.classList.remove('active');
            cardDisplay.innerHTML = '<div>ç¿»é–‹å¡ç‰‡å¾Œæœƒåœ¨é€™è£¡é¡¯ç¤º</div>';
            cardDisplay.style.transform = 'scale(1)';
            cardDisplay.style.zIndex = '1';
            cardDisplay.style.boxShadow = '0 8px 25px rgba(139, 69, 19, 0.2)';
            
            // ç¢ºä¿é‡ç½®ç¿»ç‰Œç‹€æ…‹
            isFlipped = false;
            
            // æ¸…ç†ä»»ä½•æ®˜ç•™çš„å‹•ç•«å…ƒç´ 
            const cardContainer = document.querySelector('.card-container');
            const existingFlipping = cardContainer.querySelectorAll('.flipping-page');
            const existingFlying = cardContainer.querySelectorAll('.flying-card');
            existingFlipping.forEach(el => el.remove());
            existingFlying.forEach(el => el.remove());
        }

        function flipCard() {
            if (!isFlipped) {
                const gameCard = document.getElementById('gameCard');
                const cardDisplay = document.getElementById('cardDisplay');
                const cardImage = document.getElementById('cardImage');
                const cardContainer = document.querySelector('.card-container');
                const cardStack = document.getElementById('cardStack');
                
                // éš±è—å¡ç‰‡å †ç–Šæ•ˆæœ
                cardStack.style.display = 'none';
                
                // å‰µå»ºç¿»é æ•ˆæœ - ä»¥å³é‚Šç‚ºè»¸å¿ƒç¿»é–‹ï¼Œåˆå§‹é¡¯ç¤ºé­”æ³•æ£’åœ–æ¡ˆ
                const flippingPage = document.createElement('div');
                flippingPage.className = 'flipping-page';
                flippingPage.innerHTML = 'ğŸª„';
                cardContainer.appendChild(flippingPage);
                
                // åœ¨ç¿»è½‰åˆ°90åº¦æ™‚åˆ‡æ›å…§å®¹
                setTimeout(() => {
                    flippingPage.classList.add('show-content');
                    const currentCard = gameCards[currentQuestion - 1];
                    flippingPage.innerHTML = `<img src="${currentCard.image}" alt="${currentCard.name}" class="displayed-image" style="transform: scaleX(-1);" onerror="this.src=''; this.alt='åœ–ç‰‡è¼‰å…¥å¤±æ•—'; this.style.display='none';">`;
                }, 700); // å‹•ç•«é€²è¡Œåˆ°ä¸€åŠæ™‚åˆ‡æ›å…§å®¹
                
                // ç¿»é å‹•ç•«å®Œæˆå¾Œï¼Œå‰µå»ºé£›è¡Œå¡ç‰‡ç§»å‹•åˆ°å³é‚Š
                setTimeout(() => {
                    // ç§»é™¤ç¿»é å…ƒç´ 
                    flippingPage.remove();
                    
                    // å‰µå»ºé£›è¡Œå¡ç‰‡
                    const flyingCard = document.createElement('div');
                    flyingCard.className = 'flying-card';
                    const currentCard = gameCards[currentQuestion - 1];
                    flyingCard.innerHTML = `<img src="${currentCard.image}" alt="${currentCard.name}" class="displayed-image" onerror="this.src=''; this.alt='åœ–ç‰‡è¼‰å…¥å¤±æ•—'; this.style.display='none';">`;
                    cardContainer.appendChild(flyingCard);
                    
                    // å•Ÿå‹•é£›è¡Œå‹•ç•«
                    setTimeout(() => {
                        flyingCard.classList.add('fly-to-right');
                    }, 50);
                    
                    // é£›è¡Œå‹•ç•«å®Œæˆå¾Œï¼Œåœ¨å³é‚Šé¡¯ç¤ºåœ–ç‰‡ä¸¦æ¸…ç†é£›è¡Œå¡ç‰‡
                    setTimeout(() => {
                        cardDisplay.classList.add('active');
                        const currentCard = gameCards[currentQuestion - 1];
                        cardDisplay.innerHTML = `<img src="${currentCard.image}" alt="${currentCard.name}" class="displayed-image" onerror="this.src=''; this.alt='åœ–ç‰‡è¼‰å…¥å¤±æ•—'; this.style.display='none';">`;
                        flyingCard.remove();
                        
                        // å•Ÿç”¨è€å¸«åˆ¤å®šæŒ‰éˆ•
                        const correctBtn = document.querySelector('.correct-btn');
                        const wrongBtn = document.querySelector('.wrong-btn');
                        if (correctBtn && wrongBtn) {
                            correctBtn.disabled = false;
                            correctBtn.title = 'ç­”å°äº†';
                            wrongBtn.disabled = false;
                            wrongBtn.title = 'ç­”éŒ¯äº†';
                        }
                    }, 1000);
                    
                }, 1400); // ç­‰å¾…ç¿»é å‹•ç•«å®Œæˆ
                
                isFlipped = true;
            }
        }

        function markAnswer(isCorrect) {
            // æª¢æŸ¥å¡ç‰‡æ˜¯å¦å·²ç¿»é–‹
            if (!isFlipped) {
                return;
            }
            
            // è¨˜éŒ„ç­”é¡Œçµæœ
            recordAnswer(isCorrect);
            
            if (isCorrect) {
                // ç­”å°äº†ï¼Œé¡¯ç¤ºå½ˆå‡ºæç¤ºçª—
                showPopup(isCorrect);
                
                // è‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œæˆ–å®ŒæˆéŠæˆ²
                setTimeout(() => {
                    hidePopup();
                    if (currentQuestion < 5) {
                        nextQuestion();
                    } else {
                        showCompletion();
                    }
                }, 1500);
            } else {
                // ç­”éŒ¯äº†ï¼Œæ”¾å¤§èªè©å¡è®“å­©å­å†çœ‹ä¸€æ¬¡
                enlargeCard();
            }
        }

        function recordAnswer(isCorrect) {
            if (!currentStudent) return;
            
            const currentCard = gameCards[currentQuestion - 1];
            
            // åˆå§‹åŒ–å­¸ç”Ÿè¨˜éŒ„
            if (!studentResults[currentStudent]) {
                studentResults[currentStudent] = {
                    answers: [],
                    score: 0,
                    totalQuestions: 5,
                    correctCount: 0
                };
            }
            
            // è¨˜éŒ„ç­”é¡Œçµæœ
            studentResults[currentStudent].answers.push({
                question: currentQuestion,
                word: currentCard.name,
                correct: isCorrect,
                timestamp: new Date().toISOString()
            });
            
            // æ›´æ–°åˆ†æ•¸çµ±è¨ˆ - æ¯é¡Œ20åˆ†ï¼Œåªæœ‰ç­”å°æ‰è¨ˆåˆ†
            if (isCorrect) {
                studentResults[currentStudent].correctCount++;
                studentResults[currentStudent].score = studentResults[currentStudent].correctCount * 20;
            }
            
            // è¨˜éŒ„å…¨ç­èªè©çµ±è¨ˆ
            let wordStats = JSON.parse(localStorage.getItem('wordStats') || '{}');
            if (!wordStats[currentCard.name]) {
                wordStats[currentCard.name] = { correct: 0, total: 0 };
            }
            
            if (isCorrect) {
                wordStats[currentCard.name].correct++;
            }
            wordStats[currentCard.name].total++;
            
            // ä¿å­˜åˆ°æœ¬åœ°å„²å­˜
            localStorage.setItem('studentResults', JSON.stringify(studentResults));
            localStorage.setItem('wordStats', JSON.stringify(wordStats));
        }

        function showPopup(isCorrect) {
            const overlay = document.getElementById('popupOverlay');
            const message = document.getElementById('popupMessage');
            const icon = document.getElementById('popupIcon');
            const text = document.getElementById('popupText');
            
            if (isCorrect) {
                message.className = 'popup-message popup-correct';
                icon.textContent = 'ğŸ‰';
                text.textContent = 'ç­”å°äº†ï¼å¾ˆæ£’ï¼';
            } else {
                message.className = 'popup-message popup-wrong';
                icon.textContent = 'ğŸ’ª';
                text.textContent = 'å†è©¦ä¸€æ¬¡ï¼';
            }
            
            overlay.classList.add('show');
        }

        function hidePopup() {
            const overlay = document.getElementById('popupOverlay');
            overlay.classList.remove('show');
        }

        function enlargeCard() {
            const cardDisplay = document.getElementById('cardDisplay');
            const teacherControls = document.getElementById('teacherControls');
            
            // æ”¾å¤§èªè©å¡ç‰‡
            cardDisplay.style.transform = 'scale(1.2)';
            cardDisplay.style.transition = 'transform 0.5s ease';
            cardDisplay.style.zIndex = '10';
            cardDisplay.style.boxShadow = '0 15px 40px rgba(0,0,0,0.3)';
            
            // æ›´æ–°è€å¸«æ§åˆ¶å€åŸŸï¼Œé¡¯ç¤ºæç¤ºæ–‡å­—å’Œç¹¼çºŒæŒ‰éˆ•
            teacherControls.innerHTML = `
                <div style="text-align: center; color: #f56565; font-weight: bold; margin-bottom: 15px;">
                    ğŸ“– è«‹å­©å­çœ‹è‘—åœ–ç‰‡å†å¿µä¸€æ¬¡
                </div>
                <button class="control-btn" onclick="continueAfterWrong()" 
                        style="background: linear-gradient(135deg, #deb887, #d2b48c); color: #8b4513; width: 120px; height: 50px; font-size: 1rem; border-radius: 25px;">
                    ç¹¼çºŒä¸‹ä¸€é¡Œ
                </button>
            `;
        }

        function continueAfterWrong() {
            const cardDisplay = document.getElementById('cardDisplay');
            
            // æ¢å¾©èªè©å¡ç‰‡å¤§å°
            cardDisplay.style.transform = 'scale(1)';
            cardDisplay.style.zIndex = '1';
            cardDisplay.style.boxShadow = '0 8px 25px rgba(0,0,0,0.1)';
            
            // é€²å…¥ä¸‹ä¸€é¡Œæˆ–å®ŒæˆéŠæˆ²
            if (currentQuestion < 5) {
                nextQuestion();
            } else {
                showCompletion();
            }
        }

        function nextQuestion() {
            currentQuestion++;
            updateProgress();
            loadCurrentCard();
        }

        function updateProgress() {
            const icons = document.querySelectorAll('.progress-icon');
            icons.forEach((icon, index) => {
                icon.classList.remove('completed', 'current');
                if (index < currentQuestion - 1) {
                    icon.classList.add('completed');
                } else if (index === currentQuestion - 1) {
                    icon.classList.add('current');
                }
            });
        }

        function showCompletion() {
            document.getElementById('completionMessage').style.display = 'block';
            document.querySelector('.card-container').style.display = 'none';
            document.getElementById('teacherControls').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            
            // å°‡æ‰€æœ‰é€²åº¦åœ–ç¤ºæ¨™è¨˜ç‚ºå®Œæˆ
            const icons = document.querySelectorAll('.progress-icon');
            icons.forEach(icon => {
                icon.classList.remove('current');
                icon.classList.add('completed');
            });

            // è¨˜éŒ„å­¸ç”Ÿå®Œæˆç‹€æ…‹
            if (currentStudent && !completedStudents.includes(currentStudent)) {
                completedStudents.push(currentStudent);
                localStorage.setItem('completedStudents', JSON.stringify(completedStudents));
                
                // æ›´æ–°å­¸ç”Ÿå®Œæˆæ™‚é–“
                if (studentResults[currentStudent]) {
                    studentResults[currentStudent].completedAt = new Date().toISOString();
                    localStorage.setItem('studentResults', JSON.stringify(studentResults));
                }
            }
        }

        function restartGame() {
            document.getElementById('completionMessage').style.display = 'none';
            document.querySelector('.card-container').style.display = 'block';
            document.getElementById('teacherControls').style.display = 'block';
            
            // é‡ç½®é€²åº¦åœ–ç¤º
            const icons = document.querySelectorAll('.progress-icon');
            icons.forEach((icon, index) => {
                icon.classList.remove('completed', 'current');
                if (index === 0) {
                    icon.classList.add('current');
                }
            });
            
            // è¿”å›å­¸ç”Ÿé¸æ“‡é é¢
            backToSelection();
            generateSeatButtons(); // æ›´æ–°åº§è™ŸæŒ‰éˆ•ç‹€æ…‹
            updateAnalysisButton();
        }

        function updateAnalysisButton() {
            const analysisBtn = document.getElementById('classAnalysisBtn');
            if (completedStudents.length > 0) {
                analysisBtn.style.display = 'inline-block';
            } else {
                analysisBtn.style.display = 'none';
            }
        }

        function showClassAnalysis() {
            const overlay = document.getElementById('analysisOverlay');
            const content = document.getElementById('analysisContent');
            
            const totalStudents = 30;
            const completedCount = completedStudents.length;
            const completionRate = Math.round((completedCount / totalStudents) * 100);
            
            // è¨ˆç®—å…¨ç­å¹³å‡åˆ†æ•¸ä¸¦è½‰æ›ç‚ºæ–‡å­—æè¿°
            let totalScore = 0;
            completedStudents.forEach(studentNum => {
                if (studentResults[studentNum]) {
                    totalScore += studentResults[studentNum].score || 0;
                }
            });
            const averageScore = completedCount > 0 ? Math.round(totalScore / completedCount) : 0;
            
            // å°‡åˆ†æ•¸è½‰æ›ç‚ºæ–‡å­—æè¿°
            let learningStatus = '';
            let statusColor = '';
            if (averageScore >= 80) {
                learningStatus = 'è¡¨ç¾å„ªç•°';
                statusColor = '#28a745';
            } else if (averageScore >= 60) {
                learningStatus = 'è¡¨ç¾è‰¯å¥½';
                statusColor = '#007bff';
            } else {
                learningStatus = 'å†æ¥å†å²';
                statusColor = '#dc3545';
            }
            
            // åˆ†æå®¹æ˜“ç­”éŒ¯çš„èªè©
            const wordStats = JSON.parse(localStorage.getItem('wordStats') || '{}');
            const difficultWords = Object.entries(wordStats)
                .filter(([word, stats]) => stats.total >= 1) // è‡³å°‘æœ‰1å€‹å­¸ç”Ÿç­”é
                .map(([word, stats]) => ({
                    word,
                    errorRate: Math.round(((stats.total - stats.correct) / stats.total) * 100),
                    correct: stats.correct,
                    total: stats.total
                }))
                .filter(item => item.errorRate >= 50) // ç­”éŒ¯ç‡50%ä»¥ä¸Š
                .sort((a, b) => b.errorRate - a.errorRate); // æŒ‰ç­”éŒ¯ç‡æ’åº
            
            // ç”Ÿæˆåˆ†æå…§å®¹
            content.innerHTML = `
                <div class="analysis-summary">
                    <h3>ğŸ“ˆ æ•´é«”å­¸ç¿’æ¦‚æ³</h3>
                    <p>æœ¬æ¬¡ã€Œèªè©é­”æ³•å¸«ã€æ´»å‹•å·²æœ‰ <strong>${completedCount}</strong> ä½åŒå­¸å®Œæˆï¼Œå…¨ç­å­¸ç¿’ç‹€æ³ç‚º <strong style="color: ${statusColor};">${learningStatus}</strong>ã€‚</p>
                </div>
                
                <div class="analysis-stats">
                    <div class="stat-card">
                        <div class="stat-number">${completedCount}</div>
                        <div class="stat-label">å·²å®Œæˆäººæ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: ${statusColor};">${learningStatus}</div>
                        <div class="stat-label">å…¨ç­å­¸ç¿’ç‹€æ³</div>
                    </div>
                </div>
                
                ${difficultWords.length > 0 ? `
                <div class="student-list" style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-color: #ffc107;">
                    <h3>âš ï¸ å®¹æ˜“ç­”éŒ¯çš„èªè©</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; justify-content: center;">
                        ${difficultWords.map(item => `
                            <div style="background: white; padding: 15px 25px; border-radius: 20px; border: 2px solid #ffc107; text-align: center;">
                                <div style="font-size: 1.4rem; font-weight: bold; color: #856404;">${item.word}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 15px; border: 2px solid #2196f3;">
                    <h3 style="color: #1565c0; margin-bottom: 15px;">ğŸ’¡ å­¸ç¿’å»ºè­°</h3>
                    <ul style="color: #1565c0; text-align: left; margin: 0; padding-left: 20px;">
                        <li>å»ºè­°ç¹¼çºŒé¼“å‹µå°šæœªå®Œæˆçš„åŒå­¸åƒèˆ‡æ´»å‹•</li>
                        <li>å¯ä»¥å®‰æ’å·²å®Œæˆçš„åŒå­¸å”åŠ©å…¶ä»–åŒå­¸</li>
                        ${difficultWords.length > 0 ? `<li style="color: #dc3545; font-weight: bold;">ç‰¹åˆ¥åŠ å¼·ç·´ç¿’ï¼š${difficultWords.slice(0, 3).map(item => item.word).join('ã€')} ç­‰èªè©</li>` : ''}
                        <li>æ³¨éŸ³ç¬¦è™Ÿå­¸ç¿’éœ€è¦åè¦†ç·´ç¿’ï¼Œå»ºè­°å®šæœŸè¤‡ç¿’</li>
                        <li>å¯ä»¥çµåˆå…¶ä»–æ•™å­¸æ´»å‹•å¼·åŒ–å­¸ç¿’æ•ˆæœ</li>
                        ${averageScore >= 80 ? '<li style="color: #2e7d32; font-weight: bold;">ğŸ‰ å…¨ç­è¡¨ç¾å„ªç§€ï¼å¯ä»¥é€²è¡Œä¸‹ä¸€éšæ®µçš„å­¸ç¿’æ´»å‹•</li>' : ''}
                        ${averageScore < 60 ? '<li style="color: #dc3545; font-weight: bold;">ğŸ“š å»ºè­°åŠ å¼·åŸºç¤ç·´ç¿’ï¼Œå¯å®‰æ’å€‹åˆ¥è¼”å°</li>' : ''}
                    </ul>
                </div>
            `;
            
            overlay.classList.add('show');
        }

        function closeAnalysis() {
            document.getElementById('analysisOverlay').classList.remove('show');
        }

        function resetClassProgress() {
            // å‰µå»ºè‡ªå®šç¾©ç¢ºèªå°è©±æ¡†
            const confirmOverlay = document.createElement('div');
            confirmOverlay.className = 'popup-overlay';
            confirmOverlay.style.display = 'flex';
            confirmOverlay.innerHTML = `
                <div class="popup-message" style="max-width: 500px;">
                    <div class="popup-icon" style="font-size: 3rem; color: #dc3545; margin-bottom: 20px;">âš ï¸</div>
                    <div class="popup-text" style="font-size: 1.3rem; margin-bottom: 20px;">
                        ç¢ºå®šè¦é‡è£½å…¨ç­é€²åº¦å—ï¼Ÿ<br>
                        é€™å°‡æ¸…é™¤æ‰€æœ‰å­¸ç¿’è¨˜éŒ„ï¼Œè®“ä¸‹ä¸€ç­å¯ä»¥é‡æ–°é–‹å§‹éŠæˆ²ã€‚<br>
                        <strong style="color: #dc3545;">æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</strong>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="confirmReset()" style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer;">
                            ç¢ºå®šé‡è£½
                        </button>
                        <button onclick="cancelReset()" style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer;">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmOverlay);
            
            // é¡¯ç¤ºå°è©±æ¡†
            setTimeout(() => {
                confirmOverlay.classList.add('show');
            }, 10);
            
            // ç¢ºèªé‡è£½å‡½æ•¸
            window.confirmReset = function() {
                localStorage.removeItem('completedStudents');
                localStorage.removeItem('studentResults');
                localStorage.removeItem('wordStats');
                completedStudents = [];
                studentResults = {};
                generateSeatButtons();
                updateAnalysisButton();
                
                // ç§»é™¤ç¢ºèªå°è©±æ¡†
                confirmOverlay.remove();
                delete window.confirmReset;
                delete window.cancelReset;
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showSuccessMessage();
            };
            
            // å–æ¶ˆå‡½æ•¸
            window.cancelReset = function() {
                confirmOverlay.remove();
                delete window.confirmReset;
                delete window.cancelReset;
            };
        }
        
        function showSuccessMessage() {
            const successOverlay = document.createElement('div');
            successOverlay.className = 'popup-overlay';
            successOverlay.style.display = 'flex';
            successOverlay.innerHTML = `
                <div class="popup-message popup-correct">
                    <div class="popup-icon">âœ…</div>
                    <div class="popup-text">å…¨ç­é€²åº¦å·²é‡è£½å®Œæˆï¼<br>ä¸‹ä¸€ç­å¯ä»¥é–‹å§‹éŠæˆ²äº†ã€‚</div>
                </div>
            `;
            document.body.appendChild(successOverlay);
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            setTimeout(() => {
                successOverlay.classList.add('show');
            }, 10);
            
            // 3ç§’å¾Œè‡ªå‹•é—œé–‰
            setTimeout(() => {
                successOverlay.classList.remove('show');
                setTimeout(() => {
                    successOverlay.remove();
                }, 300);
            }, 3000);
        }

        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç¿’è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                localStorage.removeItem('completedStudents');
                localStorage.removeItem('studentResults');
                localStorage.removeItem('wordStats');
                completedStudents = [];
                studentResults = {};
                generateSeatButtons();
                updateAnalysisButton();
                closeAnalysis();
            }
        }

        // --- æ–°å¢åŒ¯å‡ºåŠŸèƒ½ ---

        function showExportModal() {
            // é å…ˆå¡«å…¥ä¸Šæ¬¡è¼¸å…¥çš„è³‡æ–™
            document.getElementById('schoolNameInput').value = localStorage.getItem('exportSchoolName') || '';
            document.getElementById('classNameInput').value = localStorage.getItem('exportClassName') || '';
            
            document.getElementById('exportOverlay').classList.add('show');
            document.getElementById('exportLoading').style.display = 'none';
            
            // æš«æ™‚éš±è—åˆ†æå½ˆçª—ï¼Œé¿å…é‡ç–Š
            document.getElementById('analysisModal').style.visibility = 'hidden';
        }

        function closeExportModal() {
            document.getElementById('exportOverlay').classList.remove('show');
            // é‡æ–°é¡¯ç¤ºåˆ†æå½ˆçª—
            document.getElementById('analysisModal').style.visibility = 'visible';
        }

        // æº–å‚™è¦åŒ¯å‡ºçš„ HTML å…§å®¹
        async function prepareExportContent(schoolName, className) {
            // 1. å–å¾—åŸå§‹åˆ†æå…§å®¹
            const analysisContent = document.getElementById('analysisContent').innerHTML;
            
            // 2. å»ºç«‹æš«å­˜çš„ container
            const exportContainer = document.createElement('div');
            exportContainer.className = 'export-preview-container';
            
            // 3. åŠ å…¥æ–°çš„æ¨™é ­ï¼ˆåœ’æ‰€ã€ç­ç´šåç¨±ï¼‰
            let headerHtml = `
                <h2>${schoolName || 'èªè©é­”æ³•å¸«'}</h2>
                <h3>${className || ''} å­¸ç¿’åˆ†æå ±å‘Š</h3>
            `;
            
            // 4. çµ„åˆæ¨™é ­å’Œåˆ†æå…§å®¹
            exportContainer.innerHTML = headerHtml + analysisContent;
            
            // 5. å°‡å®ƒé™„åŠ åˆ° body (ç•«é¢å¤–)ï¼Œhtml2canvas æ‰èƒ½æ“·å–
            document.body.appendChild(exportContainer);
            
            // ç­‰å¾…ç€è¦½å™¨æ¸²æŸ“
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // 6. ä½¿ç”¨ html2canvas æ“·å–
            const canvas = await html2canvas(exportContainer, {
                scale: 2, // æé«˜è§£æåº¦
                useCORS: true,
                logging: false,
                onclone: (doc) => {
                    // ç¢ºä¿è¤‡è£½çš„ DOM æ˜¯å¯è¦‹çš„
                    const container = doc.querySelector('.export-preview-container');
                    container.style.position = 'static';
                    container.style.left = '0';
                    container.style.top = '0';
                }
            });
            
            // 7. æ¸…ç†æš«å­˜çš„ container
            document.body.removeChild(exportContainer);
            
            // 8. å›å‚³ canvas ç‰©ä»¶
            return canvas;
        }

        async function exportAsPDF() {
            const loadingSpinner = document.getElementById('exportLoading');
            loadingSpinner.style.display = 'block';

            const schoolName = document.getElementById('schoolNameInput').value;
            const className = document.getElementById('classNameInput').value;
            
            // å„²å­˜è¼¸å…¥å€¼ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨
            localStorage.setItem('exportSchoolName', schoolName);
            localStorage.setItem('exportClassName', className);
            
            try {
                const canvas = await prepareExportContent(schoolName, className);
                const imgData = canvas.toDataURL('image/png');
                
                const pdf = new jsPDF({
                    orientation: 'p', // ç¸±å‘
                    unit: 'px', // å–®ä½
                    format: 'a4' // æ ¼å¼
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // è¨ˆç®—åœ–ç‰‡é•·å¯¬æ¯”
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgWidth / imgHeight;
                
                let finalImgWidth = pdfWidth - 20; // A4 å¯¬åº¦æ¸›å»é‚Šç•Œ
                let finalImgHeight = finalImgWidth / ratio;

                // æª¢æŸ¥é«˜åº¦æ˜¯å¦è¶…å‡º
                if (finalImgHeight > pdfHeight - 20) {
                    finalImgHeight = pdfHeight - 20; // A4 é«˜åº¦æ¸›å»é‚Šç•Œ
                    finalImgWidth = finalImgHeight * ratio;
                }
                
                // ç½®ä¸­åœ–ç‰‡
                const x = (pdfWidth - finalImgWidth) / 2;
                const y = 10; // é ‚éƒ¨é‚Šç•Œ

                pdf.addImage(imgData, 'PNG', x, y, finalImgWidth, finalImgHeight);
                
                const fileName = `${schoolName || 'å­¸ç¿’åˆ†æ'}_${className || 'å ±å‘Š'}.pdf`;
                pdf.save(fileName);
                
            } catch (error) {
                console.error('åŒ¯å‡º PDF å¤±æ•—:', error);
                // åœ¨çœŸå¯¦æ‡‰ç”¨ä¸­ï¼Œæ‡‰ä½¿ç”¨è‡ªè¨‚å½ˆçª—
                alert('åŒ¯å‡º PDF æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'); 
            } finally {
                loadingSpinner.style.display = 'none';
                closeExportModal();
            }
        }

        async function exportAsImage() {
            const loadingSpinner = document.getElementById('exportLoading');
            loadingSpinner.style.display = 'block';

            const schoolName = document.getElementById('schoolNameInput').value;
            const className = document.getElementById('classNameInput').value;
            
            // å„²å­˜è¼¸å…¥å€¼
            localStorage.setItem('exportSchoolName', schoolName);
            localStorage.setItem('exportClassName', className);
            
            try {
                const canvas = await prepareExportContent(schoolName, className);
                const imgData = canvas.toDataURL('image/png');
                
                const link = document.createElement('a');
                const fileName = `${schoolName || 'å­¸ç¿’åˆ†æ'}_${className || 'å ±å‘Š'}.png`;
                link.download = fileName;
                link.href = imgData;
                
                document.body.appendChild(link); // ç‚ºäº† Firefox ç€è¦½å™¨
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error('åŒ¯å‡ºåœ–ç‰‡å¤±æ•—:', error);
                // åœ¨çœŸå¯¦æ‡‰ç”¨ä¸­ï¼Œæ‡‰ä½¿ç”¨è‡ªè¨‚å½ˆçª—
                alert('åŒ¯å‡ºåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            } finally {
                loadingSpinner.style.display = 'none';
                closeExportModal();
            }
        }
        
        // --- åŒ¯å‡ºåŠŸèƒ½çµæŸ ---
        
        // --- å…¨è¢å¹•åŠŸèƒ½ ---
        function toggleFullScreen() {
            const fsBtn = document.getElementById('fullscreenBtn');
            const enterIcon = document.getElementById('fs-enter-icon');
            const exitIcon = document.getElementById('fs-exit-icon');

            if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                // é€²å…¥å…¨è¢å¹•
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) { // Firefox
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari and Opera
                    document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
                    document.documentElement.msRequestFullscreen();
                }
            } else {
                // çµæŸå…¨è¢å¹•
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
            }
        }
        
        // ç›£è½å…¨è¢å¹•ç‹€æ…‹è®ŠåŒ– (ä¾‹å¦‚: æŒ‰ä¸‹ ESC éµ)
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('MSFullscreenChange', updateFullscreenButton);

        function updateFullscreenButton() {
            const fsBtn = document.getElementById('fullscreenBtn');
            const enterIcon = document.getElementById('fs-enter-icon');
            const exitIcon = document.getElementById('fs-exit-icon');
            
            if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                // ç›®å‰éå…¨è¢å¹•
                fsBtn.title = "å…¨è¢å¹•";
                enterIcon.style.display = 'block';
                exitIcon.style.display = 'none';
            } else {
                // ç›®å‰ç‚ºå…¨è¢å¹•
                fsBtn.title = "çµæŸå…¨è¢å¹•";
                enterIcon.style.display = 'none';
                exitIcon.style.display = 'block';
            }
        }
        // --- å…¨è¢å¹•åŠŸèƒ½çµæŸ ---


        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        initApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992f2988735bf21c',t:'MTc2MTIwMDc3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

